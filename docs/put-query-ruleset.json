{
    "meta": {
        "timestamp": "2024-11-01T03:02:53.240582",
        "size": 6350,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/put-query-ruleset.html",
        "type": "documentation",
        "role": [
            "xpack",
            "child_attributes"
        ],
        "has_code": true,
        "title": "put-query-ruleset",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[put-query-ruleset]]\n=== Create or update query ruleset\n\n++++\n<titleabbrev>Create or update query ruleset</titleabbrev>\n++++\n\nCreates or updates a query ruleset.\n\n[[put-query-ruleset-request]]\n==== {api-request-title}\n\n`PUT _query_rules/<ruleset_id>`\n\n[[put-query-ruleset-prereqs]]\n==== {api-prereq-title}\n\nRequires the `manage_search_query_rules` privilege.\n\n[role=\"child_attributes\"]\n[[put-query-ruleset-request-body]]\n(Required, object) Contains parameters for a query ruleset:\n\n==== {api-request-body-title}\n\n`rules`::\n(Required, array of objects) The specific rules included in this query ruleset.\n\nThere is a limit of 100 rules per ruleset.\nThis can be increased up to 1000 using the `xpack.applications.rules.max_rules_per_ruleset` cluster setting.\n\nEach rule must have the following information:\n\n- `rule_id` (Required, string) A unique identifier for this rule.\n- `type` (Required, string) The type of rule.\nAt this time only `pinned` and `exclude` query rule types are allowed.\n- `criteria` (Required, array of objects) The criteria that must be met for the rule to be applied.\nIf multiple criteria are specified for a rule, all criteria must be met for the rule to be applied.\n- `actions` (Required, object) The actions to take when the rule is matched.\nThe format of this action depends on the rule type.\n\nCriteria must have the following information:\n\n- `type` (Required, string) The type of criteria.\nThe following criteria types are supported:\n+\n--\n- `exact`\nOnly exact matches meet the criteria defined by the rule.\nApplicable for string or numerical values.\n- `fuzzy`\nExact matches or matches within the allowed {wikipedia}/Levenshtein_distance[Levenshtein Edit Distance] meet the criteria defined by the rule.\nOnly applicable for string values.\n- `prefix`\nMatches that start with this value meet the criteria defined by the rule.\nOnly applicable for string values.\n- `suffix`\nMatches that end with this value meet the criteria defined by the rule.\nOnly applicable for string values.\n- `contains`\nMatches that contain this value anywhere in the field meet the criteria defined by the rule.\nOnly applicable for string values.\n- `lt`\nMatches with a value less than this value meet the criteria defined by the rule.\nOnly applicable for numerical values.\n- `lte`\nMatches with a value less than or equal to this value meet the criteria defined by the rule.\nOnly applicable for numerical values.\n- `gt`\nMatches with a value greater than this value meet the criteria defined by the rule.\nOnly applicable for numerical values.\n- `gte`\nMatches with a value greater than or equal to this value meet the criteria defined by the rule.\nOnly applicable for numerical values.\n- `always`\nMatches all queries, regardless of input.\n--\n- `metadata` (Optional, string) The metadata field to match against.\nThis metadata will be used to match against `match_criteria` sent in the <<query-dsl-rule-query>>.\nRequired for all criteria types except `always`.\n- `values` (Optional, array of strings) The values to match against the metadata field.\nOnly one value must match for the criteria to be met.\nRequired for all criteria types except `always`.\n\nActions depend on the rule type.\nThe following actions are allowed for `pinned` or `exclude` rules:\n\n- `ids` (Optional, array of strings) The unique <<mapping-id-field, document IDs>> of the documents to apply the rule to.\nOnly one of `ids` or `docs` may be specified, and at least one must be specified.\n- `docs` (Optional, array of objects) The documents to apply the rule to.\nOnly one of `ids` or `docs` may be specified, and at least one must be specified.\nThere is a maximum value of 100 documents in a rule.\nYou can specify the following attributes for each document:\n+\n--\n- `_index` (Required, string) The index of the document to pin.\n- `_id` (Required, string) The unique <<mapping-id-field, document ID>>.\n--\n\nIMPORTANT: Due to limitations within <<query-dsl-pinned-query,Pinned queries>>, you can only select documents using `ids` or `docs`, but cannot use both in single rule.\nIt is advised to use one or the other in query rulesets, to avoid errors.\nAdditionally, pinned queries have a maximum limit of 100 pinned hits.\nIf multiple matching rules pin more than 100 documents, only the first 100 documents are pinned in the order they are specified in the ruleset.\n\n[[put-query-ruleset-example]]\n==== {api-examples-title}\n\nThe following example creates a new query ruleset called `my-ruleset`.\n\nTwo rules are associated with `my-ruleset`:\n\n- `my-rule1` will pin documents with IDs `id1` and `id2` when `user_query` contains `pugs` _or_ `puggles` **and** `user_country` exactly matches `us`.\n- `my-rule2` will exclude documents from different, specified indices with IDs `id3` and `id4` when the `query_string` fuzzily matches `rescue dogs`.\n\n[source,console]\n----\nPUT _query_rules/my-ruleset\n{\n    \"rules\": [\n        {\n            \"rule_id\": \"my-rule1\",\n            \"type\": \"pinned\",\n            \"criteria\": [\n                {\n                    \"type\": \"contains\",\n                    \"metadata\": \"user_query\",\n                    \"values\": [ \"pugs\", \"puggles\" ]\n                },\n                {\n                    \"type\": \"exact\",\n                    \"metadata\": \"user_country\",\n                    \"values\": [ \"us\" ]\n                }\n            ],\n            \"actions\": {\n                \"ids\": [\n                    \"id1\",\n                    \"id2\"\n                ]\n            }\n        },\n        {\n            \"rule_id\": \"my-rule2\",\n            \"type\": \"exclude\",\n            \"criteria\": [\n                {\n                    \"type\": \"fuzzy\",\n                    \"metadata\": \"user_query\",\n                    \"values\": [ \"rescue dogs\" ]\n                }\n            ],\n            \"actions\": {\n                \"docs\": [\n                    {\n                        \"_index\": \"index1\",\n                        \"_id\": \"id3\"\n                    },\n                    {\n                        \"_index\": \"index2\",\n                        \"_id\": \"id4\"\n                    }\n                ]\n            }\n        }\n    ]\n}\n----\n// TESTSETUP\n\n//////////////////////////\n\n[source,console]\n--------------------------------------------------\nDELETE _query_rules/my-ruleset\n--------------------------------------------------\n// TEARDOWN\n\n//////////////////////////\n"
}