{
    "meta": {
        "size": 3807,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline-bucket-selector-aggregation.html",
        "type": "documentation",
        "role": [],
        "has_code": true,
        "title": "search-aggregations-pipeline-bucket-selector-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-pipeline-bucket-selector-aggregation]]\n=== Bucket selector aggregation\n++++\n<titleabbrev>Bucket selector</titleabbrev>\n++++\n\nA parent pipeline aggregation which executes a script which determines whether the current bucket will be retained\nin the parent multi-bucket aggregation. The specified metric must be numeric and the script must return a boolean value.\nIf the script language is `expression` then a numeric return value is permitted. In this case 0.0 will be evaluated as `false`\nand all other values will evaluate to true.\n\nNOTE: The bucket_selector aggregation, like all pipeline aggregations, executes after all other sibling aggregations. This means that\nusing the bucket_selector aggregation to filter the returned buckets in the response does not save on execution time running the aggregations.\n\n==== Syntax\n\nA `bucket_selector` aggregation looks like this in isolation:\n\n[source,js]\n--------------------------------------------------\n{\n  \"bucket_selector\": {\n    \"buckets_path\": {\n      \"my_var1\": \"the_sum\",                     <1>\n      \"my_var2\": \"the_value_count\"\n    },\n    \"script\": \"params.my_var1 > params.my_var2\"\n  }\n}\n--------------------------------------------------\n// NOTCONSOLE\n<1> Here, `my_var1` is the name of the variable for this buckets path to use in the script, `the_sum` is the path to\nthe metrics to use for that variable.\n\n[[bucket-selector-params]]\n.`bucket_selector` Parameters\n[options=\"header\"]\n|===\n|Parameter Name |Description |Required |Default Value\n|`script` |The script to run for this aggregation. The script can be inline, file or indexed. (see <<modules-scripting>>\nfor more details) |Required |\n|`buckets_path` |A map of script variables and their associated path to the buckets we wish to use for the variable\n(see <<buckets-path-syntax>> for more details) |Required |\n|`gap_policy` |The policy to apply when gaps are found in the data (see <<gap-policy>> for more\n details)|Optional |`skip`\n|===\n\nThe following snippet only retains buckets where the total sales for the month is more than 200:\n\n[source,console]\n--------------------------------------------------\nPOST /sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"sales_per_month\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"\n      },\n      \"aggs\": {\n        \"total_sales\": {\n          \"sum\": {\n            \"field\": \"price\"\n          }\n        },\n        \"sales_bucket_filter\": {\n          \"bucket_selector\": {\n            \"buckets_path\": {\n              \"totalSales\": \"total_sales\"\n            },\n            \"script\": \"params.totalSales > 200\"\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n\nAnd the following may be the response:\n\n[source,console-result]\n--------------------------------------------------\n{\n   \"took\": 11,\n   \"timed_out\": false,\n   \"_shards\": ...,\n   \"hits\": ...,\n   \"aggregations\": {\n      \"sales_per_month\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"2015/01/01 00:00:00\",\n               \"key\": 1420070400000,\n               \"doc_count\": 3,\n               \"total_sales\": {\n                   \"value\": 550.0\n               }\n            },<1>\n            {\n               \"key_as_string\": \"2015/03/01 00:00:00\",\n               \"key\": 1425168000000,\n               \"doc_count\": 2,\n               \"total_sales\": {\n                   \"value\": 375.0\n               }\n            }\n         ]\n      }\n   }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\"took\": 11/\"took\": $body.took/]\n// TESTRESPONSE[s/\"_shards\": \\.\\.\\./\"_shards\": $body._shards/]\n// TESTRESPONSE[s/\"hits\": \\.\\.\\./\"hits\": $body.hits/]\n\n<1> Bucket for `2015/02/01 00:00:00` has been removed as its total sales was less than 200\n"
}