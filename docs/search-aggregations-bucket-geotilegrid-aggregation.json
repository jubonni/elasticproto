{
    "meta": {
        "timestamp": "2024-11-01T03:07:09.284271",
        "size": 8132,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geotilegrid-aggregation.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "search-aggregations-bucket-geotilegrid-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-bucket-geotilegrid-aggregation]]\n=== Geotile grid aggregation\n++++\n<titleabbrev>Geotile grid</titleabbrev>\n++++\n\nA multi-bucket aggregation that groups <<geo-point,`geo_point`>> and\n<<geo-shape,`geo_shape`>> values into buckets that represent a grid.\nThe resulting grid can be sparse and only\ncontains cells that have matching data. Each cell corresponds to a\n{wikipedia}/Tiled_web_map[map tile] as used by many online map\nsites. Each cell is labeled using a \"{zoom}/{x}/{y}\" format, where zoom is equal\nto the user-specified precision.\n\n* High precision keys have a larger range for x and y, and represent tiles that\ncover only a small area.\n* Low precision keys have a smaller range for x and y, and represent tiles that\neach cover a large area.\n\nSee https://wiki.openstreetmap.org/wiki/Zoom_levels[zoom level documentation]\non how precision (zoom) correlates to size on the ground. Precision for this\naggregation can be between 0 and 29, inclusive.\n\nWARNING: The highest-precision geotile of length 29 produces cells that cover\nless than a 10cm by 10cm of land and so high-precision requests can be very\ncostly in terms of RAM and result sizes. Please see the example below on how\nto first filter the aggregation to a smaller geographic area before requesting\nhigh-levels of detail.\n\nYou can only use `geotile_grid` to aggregate an explicitly mapped `geo_point` or\n`geo_shape` field. If the `geo_point` field contains an array, `geotile_grid`\naggregates all the array values.\n\n\n==== Simple low-precision request\n\n[source,console,id=geotilegrid-aggregation-example]\n--------------------------------------------------\nPUT /museums\n{\n  \"mappings\": {\n    \"properties\": {\n      \"location\": {\n        \"type\": \"geo_point\"\n      }\n    }\n  }\n}\n\nPOST /museums/_bulk?refresh\n{\"index\":{\"_id\":1}}\n{\"location\": \"POINT (4.912350 52.374081)\", \"name\": \"NEMO Science Museum\"}\n{\"index\":{\"_id\":2}}\n{\"location\": \"POINT (4.901618 52.369219)\", \"name\": \"Museum Het Rembrandthuis\"}\n{\"index\":{\"_id\":3}}\n{\"location\": \"POINT (4.914722 52.371667)\", \"name\": \"Nederlands Scheepvaartmuseum\"}\n{\"index\":{\"_id\":4}}\n{\"location\": \"POINT (4.405200 51.222900)\", \"name\": \"Letterenhuis\"}\n{\"index\":{\"_id\":5}}\n{\"location\": \"POINT (2.336389 48.861111)\", \"name\": \"Mus\u00e9e du Louvre\"}\n{\"index\":{\"_id\":6}}\n{\"location\": \"POINT (2.327000 48.860000)\", \"name\": \"Mus\u00e9e d'Orsay\"}\n\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"large-grid\": {\n      \"geotile_grid\": {\n        \"field\": \"location\",\n        \"precision\": 8\n      }\n    }\n  }\n}\n--------------------------------------------------\n\nResponse:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"large-grid\": {\n      \"buckets\": [\n        {\n          \"key\": \"8/131/84\",\n          \"doc_count\": 3\n        },\n        {\n          \"key\": \"8/129/88\",\n          \"doc_count\": 2\n        },\n        {\n          \"key\": \"8/131/85\",\n          \"doc_count\": 1\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"_shards\": $body._shards,\"hits\":$body.hits,\"timed_out\":false,/]\n\n[[geotilegrid-high-precision]]\n==== High-precision requests\n\nWhen requesting detailed buckets (typically for displaying a \"zoomed in\" map),\na filter like <<query-dsl-geo-bounding-box-query,geo_bounding_box>> should be\napplied to narrow the subject area. Otherwise, potentially millions of buckets\nwill be created and returned.\n\n[source,console,id=geotilegrid-high-precision-ex]\n--------------------------------------------------\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"zoomed-in\": {\n      \"filter\": {\n        \"geo_bounding_box\": {\n          \"location\": {\n            \"top_left\": \"POINT (4.9 52.4)\",\n            \"bottom_right\": \"POINT (5.0 52.3)\"\n          }\n        }\n      },\n      \"aggregations\": {\n        \"zoom1\": {\n          \"geotile_grid\": {\n            \"field\": \"location\",\n            \"precision\": 22\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[continued]\n\nResponse:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"zoomed-in\": {\n      \"doc_count\": 3,\n      \"zoom1\": {\n        \"buckets\": [\n          {\n            \"key\": \"22/2154412/1378379\",\n            \"doc_count\": 1\n          },\n          {\n            \"key\": \"22/2154385/1378332\",\n            \"doc_count\": 1\n          },\n          {\n            \"key\": \"22/2154259/1378425\",\n            \"doc_count\": 1\n          }\n        ]\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"_shards\": $body._shards,\"hits\":$body.hits,\"timed_out\":false,/]\n\n[[geotilegrid-addtl-bounding-box-filtering]]\n==== Requests with additional bounding box filtering\n\nThe `geotile_grid` aggregation supports an optional `bounds` parameter\nthat restricts the cells considered to those that intersect the\nprovided bounds. The `bounds` parameter accepts the same\n<<query-dsl-geo-bounding-box-query-accepted-formats,bounding box formats>>\nas the geo-bounding box query. This bounding box can be used with or\nwithout an additional `geo_bounding_box` query for filtering the points prior to aggregating.\nIt is an independent bounding box that can intersect with, be equal to, or be disjoint\nto any additional `geo_bounding_box` queries defined in the context of the aggregation.\n\n[source,console,id=geotilegrid-aggregation-with-bounds]\n--------------------------------------------------\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"tiles-in-bounds\": {\n      \"geotile_grid\": {\n        \"field\": \"location\",\n        \"precision\": 22,\n        \"bounds\": {\n          \"top_left\": \"POINT (4.9 52.4)\",\n          \"bottom_right\": \"POINT (5.0 52.3)\"\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[continued]\n\nResponse:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"tiles-in-bounds\": {\n      \"buckets\": [\n        {\n          \"key\": \"22/2154412/1378379\",\n          \"doc_count\": 1\n        },\n        {\n          \"key\": \"22/2154385/1378332\",\n          \"doc_count\": 1\n        },\n        {\n          \"key\": \"22/2154259/1378425\",\n          \"doc_count\": 1\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"_shards\": $body._shards,\"hits\":$body.hits,\"timed_out\":false,/]\n\n[discrete]\n[role=\"xpack\"]\n[[geotilegrid-aggregating-geo-shape]]\n==== Aggregating `geo_shape` fields\n\nAggregating on <<geo-shape>> fields works almost as it does for points, except that a single\nshape can be counted for in multiple tiles. A shape will contribute to the count of matching values\nif any part of its shape intersects with that tile. Below is an image that demonstrates this:\n\n\nimage:images/spatial/geoshape_grid.png[]\n\n==== Options\n\n[horizontal]\nfield::\n(Required, string) Field containing indexed geo-point or geo-shape values.\nMust be explicitly mapped as a <<geo-point,`geo_point`>> or a <<geo-shape,`geo_shape`>> field.\nIf the field contains an array, `geotile_grid` aggregates all array values.\n\nprecision::\n(Optional, integer) Integer zoom of the key used to define cells/buckets in\nthe results. Defaults to `7`. Values outside of [`0`,`29`] will be rejected.\n\nbounds::\n(Optional, object) Bounding box used to filter the geo-points or geo-shapes in each bucket.\nAccepts the same bounding box formats as the\n<<query-dsl-geo-bounding-box-query-accepted-formats,geo-bounding box query>>.\n\nsize::\n(Optional, integer) Maximum number of buckets to return. Defaults to 10,000.\nWhen results are trimmed, buckets are prioritized based on the volume of\ndocuments they contain.\n\nshard_size::\n(Optional, integer) Number of buckets returned from each shard. Defaults to\n`max(10,(size x number-of-shards))` to allow for a more accurate count of the\ntop cells in the final result. Since each shard could have a different top result order,\nusing a larger number here reduces the risk of inaccurate counts, but incurs a performance cost.\n"
}