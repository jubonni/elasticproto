{
    "meta": {
        "timestamp": "2024-11-01T03:02:53.454585",
        "size": 21222,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup-https.html",
        "type": "documentation",
        "role": [],
        "has_code": false,
        "title": "security-basic-setup-https",
        "version": "8.15"
    },
    "doc": "[[security-basic-setup-https]]\n=== Set up basic security for the Elastic Stack plus secured HTTPS traffic\n++++\n<titleabbrev>Set up basic security plus HTTPS</titleabbrev>\n++++\n\nWhen you enable TLS on the HTTP layer it provides an additional layer of\nsecurity to ensure that all communications to and from your\ncluster are encrypted.\n\nWhen you run the `elasticsearch-certutil` tool in `http` mode, the tool asks\nseveral questions about how you want to generate certificates. While there are\nnumerous options, the following choices result in certificates that should\nwork for most environments.\n\n[[signing-certificates]]\n.Signing certificates\n****\nThe first question that the `elasticsearch-certutil` tool prompts you with is\nwhether you want to generate a Certificate Signing Request (CSR). Answer\n`n` if you want to sign your own certificates, or `y` if you want to sign\ncertificates with a central CA.\n\n[discrete]\n===== Sign your own certificates\n\nIf you want to use the CA that you created when\n<<generate-certificates,Generating the certificate authority>> answer `n` when\nasked if you want to generate a CSR. You then specify the location of your CA,\nwhich the tool uses to sign and generate a `.p12` certificate. The steps in\nthis procedure follow this workflow.\n\n[discrete]\n===== Sign certificates with a central CA\n\nIf you work in an environment with a central security team, they can likely\ngenerate a certificate for you. Infrastructure within your organization\nmight already be configured to trust an existing CA, so it may be easier\nfor clients to connect to {es} if you use a CSR and send that\nrequest to the team that controls your CA. To use a central CA, answer `y` to\nthe first question.\n****\n\n[[basic-setup-https-prerequisites]]\n==== Prerequisites\n\nComplete all steps in <<security-basic-setup,Set up basic security for the Elastic Stack>>.\n\n[[encrypt-http-communication]]\n==== Encrypt HTTP client communications for {es}\n\n. On *every* node in your cluster, stop {es} and {kib} if they are running.\n\n. On any single node, from the directory where you installed {es}, run the {es}\n   HTTP certificate tool to generate a Certificate Signing Request (CSR).\n+\n[source,shell]\n----\n./bin/elasticsearch-certutil http\n----\n+\nThis command generates a `.zip` file that contains certificates and keys\nto use with {es} and {kib}. Each folder contains a `README.txt`\nexplaining how to use these files.\n\n   a. When asked if you want to generate a CSR, enter `n`.\n\n   b. When asked if you want to use an existing CA, enter `y`.\n\n   c. Enter the path to your CA. This is the absolute path to\n   the `elastic-stack-ca.p12` file that you generated for your cluster.\n\n   d. Enter the password for your CA.\n\n   e. Enter an expiration value for your certificate. You can enter the\n   validity period in years, months, or days. For example, enter `90D` for 90\n   days.\n\n   f. When asked if you want to generate one certificate per node, enter `y`.\n+\nEach certificate will have its own private key, and will be issued for a\nspecific hostname or IP address.\n\n   g. When prompted, enter the name of the first node in your cluster. Use the same node name that you used when <<generate-certificates,generating node certificates>>.\n\n   h. Enter all hostnames used to connect to your first node. These hostnames\n   will be added as DNS names in the Subject Alternative Name (SAN) field in your certificate.\n+\nList every hostname and variant used to connect to your cluster over HTTPS.\n\n   i. Enter the IP addresses that clients can use to connect to your node.\n\n   j. Repeat these steps for each additional node in your cluster.\n\n. After generating a certificate for each of your nodes, enter a password for\n   your private key when prompted.\n\n. Unzip the generated `elasticsearch-ssl-http.zip` file. This compressed file\n   contains one directory for both {es} and {kib}.\n+\n--\n[source,txt]\n----\n/elasticsearch\n|_ README.txt\n|_ http.p12\n|_ sample-elasticsearch.yml\n----\n\n[source,txt]\n----\n/kibana\n|_ README.txt\n|_ elasticsearch-ca.pem\n|_ sample-kibana.yml\n----\n--\n\n. On *every* node in your cluster, complete the following steps:\n\n  .. Copy the relevant `http.p12` certificate to the `$ES_PATH_CONF` directory.\n\n  .. Edit the `elasticsearch.yml` file to enable HTTPS security and specify the\n  location of the `http.p12` security certificate.\n+\n[source,yaml]\n----\nxpack.security.http.ssl.enabled: true\nxpack.security.http.ssl.keystore.path: http.p12\n----\n\n  .. Add the password for your private key to the secure settings in {es}.\n+\n[source,shell]\n----\n./bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password\n----\n\n  .. Start {es}.\n\n**Next**: <<encrypt-kibana-http,Encrypt HTTP client communications for {kib}>>\n\n[[encrypt-kibana-http]]\n==== Encrypt HTTP client communications for {kib}\n\nBrowsers send traffic to {kib} and {kib} sends traffic to {es}.\nThese communication channels are configured separately to use TLS. You encrypt\ntraffic between {kib} and {es}, and then encrypt traffic between your browser\nand {kib}.\n\n[[encrypt-kibana-elasticsearch]]\n===== Encrypt traffic between {kib} and {es}\n\nWhen you ran the `elasticsearch-certutil` tool with the `http` option, it\ncreated a `/kibana` directory containing an `elasticsearch-ca.pem` file. You\nuse this file to configure {kib} to trust the {es} CA for the HTTP\nlayer.\n\n. Copy the `elasticsearch-ca.pem` file to the {kib} configuration directory,\nas defined by the `$KBN_PATH_CONF` path.\n\n. Open `kibana.yml` and add the following line to specify the location of the\nsecurity certificate for the HTTP layer.\n+\n[source,yaml]\n----\nelasticsearch.ssl.certificateAuthorities: $KBN_PATH_CONF/elasticsearch-ca.pem\n----\n\n. Add the following line to specify the HTTPS URL for your {es}\ncluster.\n+\n[source,yaml]\n----\nelasticsearch.hosts: https://<your_elasticsearch_host>:9200\n----\n\n. Restart {kib}.\n\n.Connect to a secure monitoring cluster\n****\nIf the Elastic monitoring features are enabled and you configured a separate\n{es} monitoring cluster, you can also configure {kib} to connect to\nthe monitoring cluster via HTTPS. The steps are the same, but each setting is\nprefixed by `monitoring`. For example, `monitoring.ui.elasticsearch.hosts` and\n`monitoring.ui.elasticsearch.ssl.truststore.path`.\n\nNOTE: You must create a separate `elasticsearch-ca.pem` security file for the\nmonitoring cluster.\n****\n\n**Next**: <<encrypt-kibana-browser,Encrypt traffic between your browser and {kib}>>\n\n[[encrypt-kibana-browser]]\n===== Encrypt traffic between your browser and {kib}\n\nYou create a server certificate and private key for {kib}. {kib} uses this\nserver certificate and corresponding private key when receiving connections\nfrom web browsers.\n\nWhen you obtain a server certificate, you must set its subject alternative\nname (SAN) correctly to ensure that browsers will trust it. You can set one or\nmore SANs to the {kib} server\u2019s fully-qualified domain name (FQDN), hostname,\nor IP address. When choosing the SAN, pick whichever attribute you'll use to\nconnect to {kib} in your browser, which is likely the FQDN.\n\nThe following instructions create a Certificate Signing Request (CSR) for {kib}.\nA CSR contains information that a CA uses to generate and sign a security\ncertificate. The certificate can be trusted (signed by a public, trusted CA)\nor untrusted (signed by an internal CA). A self-signed or internally-signed\ncertificate is acceptable for development environments and building a proof of\nconcept, but should not be used in a production environment.\n\nWARNING: Before going to production, use a trusted CA such as https://letsencrypt.org/[Let's\nEncrypt] or your organization's internal CA to sign the certificate. Using a\nsigned certificate establishes browser trust for connections to {kib} for\ninternal access or on the public internet.\n\n. Generate a server certificate and private key for {kib}.\n+\n[source,shell]\n----\n./bin/elasticsearch-certutil csr -name kibana-server -dns example.com,www.example.com\n----\n+\nThe CSR has a common name (CN) of `kibana-server`, a SAN of `example.com`,\nand another SAN of `www.example.com`.\n+\nThis command generates a `csr-bundle.zip` file by default with the following\ncontents:\n+\n[source,txt]\n----\n/kibana-server\n|_ kibana-server.csr\n|_ kibana-server.key\n----\n\n. Unzip the `csr-bundle.zip` file to obtain the `kibana-server.csr` unsigned\nsecurity certificate and the `kibana-server.key` unencrypted private key.\n\n. Send the `kibana-server.csr` certificate signing request to your internal\nCA or trusted CA for signing to obtain a signed certificate. The signed file\ncan be in different formats, such as a `.crt` file like `kibana-server.crt`.\n\n. Open `kibana.yml` and add the following lines to configure {kib} to access\nthe server certificate and unencrypted private key.\n+\n[source,yaml]\n----\nserver.ssl.certificate: $KBN_PATH_CONF/kibana-server.crt\nserver.ssl.key: $KBN_PATH_CONF/kibana-server.key\n----\n+\nNOTE: `$KBN_PATH_CONF` contains the path for the {kib} configuration files. If\nyou installed {kib} using archive distributions (`zip` or `tar.gz`), the\npath defaults to `$KBN_HOME/config`. If you used package distributions\n(Debian or RPM), the path defaults to `/etc/kibana`.\n\n. Add the following line to `kibana.yml` to enable TLS for inbound\nconnections.\n+\n[source,yaml]\n----\nserver.ssl.enabled: true\n----\n\n. Start {kib}.\n\nNOTE: After making these changes, you must always access {kib} via HTTPS. For\nexample, `https://<your_kibana_host>.com`.\n\n**Next**: <<configure-beats-security,Configure {beats} security>>\n\n[[configure-beats-security]]\n==== Configure {beats} security\n{beats} are open source data shippers that you install as agents on your\nservers to send operational data to {es}. Each Beat is a separately\ninstallable product. The following steps cover configuring security for\n{metricbeat}. Follow these steps for each \n{beats-ref}/getting-started.html[additional Beat] you want to configure security\nfor.\n\n===== Prerequisites\n\n{metricbeat-ref}/metricbeat-installation-configuration.html[Install {metricbeat}] using your preferred method.\n\nIMPORTANT: You cannot connect to the {stack} or configure assets for {metricbeat}\nbefore completing the following steps.\n\n===== Create roles for {metricbeat}\nTypically, you need to create the following separate roles:\n\n- **setup** role for setting up index templates and other dependencies\n- **monitoring** role for sending monitoring information\n- **writer** role for publishing events collected by {metricbeat}\n- **reader** role for Kibana users who need to view and create visualizations that access {metricbeat} data\n\nNOTE: These instructions assume that you are using the default name for\n{metricbeat} indices. If the indicated index names are not listed, or you are\nusing a custom name, enter it manually when defining roles and modify the\nprivileges to match your index naming pattern.\n\nTo create users and roles from Stack Management in {kib}, select **Roles**\nor **Users** from the side navigation.\n\n**Next**: <<beats-setup-role,Create a setup role>>\n\n[discrete]\n[[beats-setup-role]]\n====== Create a setup role and user\n\nAdministrators who set up {metricbeat} typically need to load mappings,\ndashboards, and other objects used to index data into {es} and visualize it in\n{kib}.\n\nWARNING: Setting up {metricbeat} is an admin-level task that requires extra\nprivileges. As a best practice, grant the setup role to administrators only,\nand use a more restrictive role for event publishing.\n\n. Create the setup role:\n\n   . Enter **metricbeat_setup** as the role name.\n\n   . Choose the **monitor** and **manage_ilm** cluster privileges.\n\n   . On the **metricbeat-\\*** indices, choose the **manage** and **write**\n   privileges.\n+\nIf the **metricbeat-\\*** indices aren't listed, enter that pattern into the\nlist of indices.\n\n. Create the setup user:\n\n   . Enter **metricbeat_setup** as the user name.\n\n   . Enter the username, password, and other user details.\n\n   . Assign the following roles to the **metricbeat_setup** user:\n+\n[cols=\"1,1\"]\n|===\n| Role               | Purpose\n\n| `metricbeat_setup` | Set up {metricbeat}.\n| `kibana_admin`     | Load dependencies, such as example dashboards, if available, into {kib}\n| `ingest_admin`     | Set up index templates and, if available, ingest pipelines\n|===\n\n**Next**: <<beats-monitoring-role,Create a monitoring role>>\n\n[discrete]\n[[beats-monitoring-role]]\n====== Create a monitoring role and user\n\nTo send monitoring data securely, create a monitoring user and grant it the\nnecessary privileges.\n\nYou can use the built-in `beats_system` user, if it\u2019s available in your\nenvironment. Because the built-in users are not available in {ecloud},\nthese instructions create a user that is explicitly used for monitoring\n{metricbeat}.\n\n. If you're using the built-in `beats_system` user, on any node in your cluster,\nrun the <<reset-password,`elasticsearch-reset-password`>> utility to set the\npassword for that user:\n+\nThis command resets the password for the `beats_system` user to an \nauto-generated value.\n+\n[source,shell]\n----\n./bin/elasticsearch-reset-password -u beats_system\n----\n+\nIf you want to set the password to a specific value, run the command with the \ninteractive (`-i`) parameter.\n+\n[source,shell]\n----\n./bin/elasticsearch-reset-password -i -u beats_system\n----\n\n. Create the monitoring role:\n\n   . Enter **metricbeat_monitoring** as the role name.\n\n   . Choose the **monitor** cluster privilege.\n\n   . On the **.monitoring-beats-\\*** indices, choose the **create_index** and\n   **create_doc** privileges.\n\n. Create the monitoring user:\n\n   . Enter **metricbeat_monitoring** as the user name.\n\n   . Enter the username, password, and other user details.\n\n   . Assign the following roles to the **metricbeat_monitoring** user:\n+\n[cols=\"1,1\"]\n|===\n| Role                    | Purpose\n\n| `metricbeat_monitoring` | Monitor {metricbeat}.\n| `kibana_admin`          | Use {kib}\n| `monitoring_user`       | Use Stack Monitoring in {kib} to monitor {metricbeat}\n|===\n\n**Next**: <<beats-writer-role,Create a writer role>>\n\n[discrete]\n[[beats-writer-role]]\n====== Create a writer role and user\n\nUsers who publish events to {es} need to create and write to {metricbeat} indices. To minimize the privileges required by the writer role, use the setup role to pre-load dependencies. This section assumes that you\u2019ve\n<<beats-setup-role,created the setup role>>.\n\n. Create the writer role:\n\n   . Enter **metricbeat_writer** as the role name.\n\n   . Choose the **monitor** and **read_ilm** cluster privileges.\n\n   . On the **metricbeat-\\*** indices, choose the **create_doc**, **create_index**, and **view_index_metadata** privileges.\n\n. Create the writer user:\n\n   . Enter **metricbeat_writer** as the user name.\n\n   . Enter the username, password, and other user details.\n\n   . Assign the following roles to the **metricbeat_writer** user:\n+\n[cols=\"1,1\"]\n|===\n| Role                          | Purpose\n\n| `metricbeat_writer`           | Monitor {metricbeat}\n| `remote_monitoring_collector` | Collect monitoring metrics from {metricbeat}\n| `remote_monitoring_agent`     | Send monitoring data to the monitoring cluster\n|===\n\n**Next**: <<beats-reader-role,Create a reader role>>\n\n[discrete]\n[[beats-reader-role]]\n====== Create a reader role and user\n\n{kib} users typically need to view dashboards and visualizations that contain\n{metricbeat} data. These users might also need to create and edit dashboards\nand visualizations. Create the reader role to assign proper privileges to these\nusers.\n\n. Create the reader role:\n\n   . Enter **metricbeat_reader** as the role name.\n\n   . On the **metricbeat-\\*** indices, choose the **read** privilege.\n\n   . Under **Kibana**, click **Add Kibana privilege**.\n\n   - Under **Spaces**, choose **Default**.\n\n   - Choose **Read** or **All** for Discover, Visualize, Dashboard, and Metrics.\n\n. Create the reader user:\n\n   . Enter **metricbeat_reader** as the user name.\n\n   . Enter the username, password, and other user details.\n\n   . Assign the following roles to the **metricbeat_reader** user:\n+\n[cols=\"1,1\"]\n|===\n| Role                          | Purpose\n\n| `metricbeat_reader` | Read {metricbeat} data.\n| `monitoring_user`   | Allow users to monitor the health of {metricbeat}\nitself. Only assign this role to users who manage {metricbeat}\n| `beats_admin`       | Create and manage configurations in {beats} central\nmanagement. Only assign this role to users who need to use {beats} central\nmanagement.\n|===\n\n**Next**: <<configure-metricbeat-tls,Configure {metricbeat} to use TLS>>\n\n[discrete]\n[[configure-metricbeat-tls]]\n===== Configure {metricbeat} to use TLS\n\nBefore starting {metricbeat}, you configure the connections to {es} and\n{kib}. You can configure authentication to send data to your secured cluster\nusing basic authentication, API key authentication, or Public Key\nInfrastructure (PKI) certificates.\n\nThe following instructions use the credentials for the `metricbeat_writer`\nand `metricbeat_setup` users that you created. If you need a greater level of\nsecurity, we recommend using PKI certificates.\n\nAfter configuring connections to {es} and {kib}, you'll enable the\n`elasticsearch-xpack` module and configure that module to use HTTPS.\n\nWARNING: In production environments, we strongly recommend using a separate\ncluster (referred to as the monitoring cluster) to store your data. Using a\nseparate monitoring cluster prevents production cluster outages from impacting\nyour ability to access your monitoring data. It also prevents monitoring\nactivities from impacting the performance of your production cluster.\n\n. On the node where you\n<<encrypt-http-communication,generated certificates for the HTTP layer>>,\nnavigate to the `/kibana` directory.\n\n. Copy the `elasticsearch-ca.pem` certificate to the directory where you\ninstalled {metricbeat}.\n\n. Open the `metricbeat.yml` configuration file and configure the connection\nto {es}.\n+\nUnder `output.elasticsearch`, specify the following fields:\n+\n[source,yaml]\n----\noutput.elasticsearch:\n hosts: [\"<your_elasticsearch_host>:9200\"]\n protocol: \"https\"\n username: \"metricbeat_writer\"\n password: \"<password>\"\n ssl:\n   certificate_authorities: [\"elasticsearch-ca.pem\"]\n   verification_mode: \"certificate\"\n----\n\n   `hosts`:: Specifies the host where your {es} cluster is running.\n\n   `protocol`:: Indicates the protocol to use when connecting to {es}.\n   This value must be `https`.\n\n   `username`:: Name of the user with privileges required to publish events to\n   {es}. The `metricbeat_writer` user that you created has these\n   privileges.\n\n   `password`:: Password for the indicated `username`.\n\n   `certificate_authorities`:: Indicates the path to the local `.pem` file that\n   contains your CA's certificate. \n\n. Configure the connection to {kib}.\n+\nUnder `setup.kibana`, specify the following fields:\n+\n[source,yaml]\n----\nsetup.kibana\n host: \"https://<your_elasticsearch_host>:5601\"\n ssl.enabled: true\n username: \"metricbeat_setup\"\n password: \"p@ssw0rd\"\n----\n\n   `hosts`:: The URLs of the {es} instances to use for all your\n   queries. Ensure that you include `https` in the URL.\n\n   `username`:: Name of the user with privileges required to set up dashboards in {kib}. The `metricbeat_setup` user that you created has these privileges.\n\n   `password`:: Password for the indicated `username`.\n\n. Enable the `elasticsearch-xpack` module.\n+\n[source,shell]\n----\n./metricbeat modules enable elasticsearch-xpack\n----\n\n. Modify the `elasticsearch-xpack` module to use HTTPS. This module collects\nmetrics about {es}.\n+\nOpen `/modules.d/elasticsearch-xpack.yml` and specify the following fields:\n+\n[source,yaml]\n----\n- module: elasticsearch\n xpack.enabled: true\n period: 10s\n hosts: [\"https://<your_elasticsearch_host>:9200\"]\n username: \"remote_monitoring_user\"\n password: \"<password>\"\n ssl:     <1>\n   enabled: true\n   certificate_authorities: [\"elasticsearch-ca.pem\"]\n   verification_mode: \"certificate\"\n----\n<1> Configuring SSL is required when monitoring a node with encrypted traffic.\nSee {metricbeat-ref}/configuration-ssl.html[Configure SSL for {metricbeat}].\n\n   `hosts`:: Specifies the host where your {es} cluster is running.\n   Ensure that you include `https` in the URL.\n\n   `username`:: Name of the user with privileges to collect metric data. The\n   built-in `monitoring_user` user has these privileges. Alternatively,\n   you can create a user and assign it the `monitoring_user` role.\n\n   `password`:: Password for the indicated `username`.\n\n   `certificate_authorities`:: Indicates the path to the local `.pem` file that\n   contains your CA's certificate. \n\n. If you want to use the predefined assets for parsing, indexing, and\n   visualizing your data, run the following command to load these assets:\n+\n[source,shell]\n----\n./metricbeat setup -e\n----\n\n. Start {es}, and then start {metricbeat}.\n+\n[source,shell]\n----\n./metricbeat -e\n----\n+\n`-e` is optional and sends output to standard error instead of the configured\nlog output.\n\n. Log in to {kib}, open the main menu, and click **Stack Monitoring**.\n+\nYou\u2019ll see cluster alerts that require your attention and a summary of the available monitoring metrics for {es}. Click any of the header links on the available cards to view additional information.\n"
}