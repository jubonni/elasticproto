{
    "meta": {
        "size": 10252,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/set-up-a-data-stream.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "set-up-a-data-stream",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[set-up-a-data-stream]]\n== Set up a data stream\n\nTo set up a data stream, follow these steps:\n\n. <<create-index-lifecycle-policy>>\n. <<create-component-templates>>\n. <<create-index-template>>\n. <<create-data-stream>>\n. <<secure-data-stream>>\n\nYou can also <<convert-index-alias-to-data-stream,convert an index alias to\na data stream>>.\n\n[IMPORTANT] \n--\nIf you use {fleet}, {agent}, or {ls}, skip this tutorial. \nThey all set up data streams for you. \n\nFor {fleet} and {agent}, check out this {fleet-guide}/data-streams.html[data streams documentation].\nFor {ls}, check out the\n{logstash-ref}/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-data_stream[data streams settings]\nfor the `elasticsearch output` plugin.\n--\n\n[discrete]\n[[create-index-lifecycle-policy]]\n=== Create an index lifecycle policy\n\nWhile optional, we recommend using {ilm-init} to automate the management of your\ndata stream's backing indices. {ilm-init} requires an index lifecycle policy.\n\nTo create an index lifecycle policy in {kib}, open the main menu and go to\n*Stack Management > Index Lifecycle Policies*. Click *Create policy*.\n\nYou can also use the <<ilm-put-lifecycle,create lifecycle policy API>>.\n\n////\n[source,console]\n--------------------------------------------------\nPUT /_snapshot/found-snapshots\n{\n \"type\": \"fs\",\n  \"settings\": {\n    \"location\": \"my_backup_location\"\n  }\n}\n--------------------------------------------------\n// TESTSETUP\n////\n\n// tag::ilm-policy-api-ex[]\n[source,console]\n----\nPUT _ilm/policy/my-lifecycle-policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_primary_shard_size\": \"50gb\"\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"30d\",\n        \"actions\": {\n          \"shrink\": {\n            \"number_of_shards\": 1\n          },\n          \"forcemerge\": {\n            \"max_num_segments\": 1\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"60d\",\n        \"actions\": {\n          \"searchable_snapshot\": {\n            \"snapshot_repository\": \"found-snapshots\"\n          }\n        }\n      },\n      \"frozen\": {\n        \"min_age\": \"90d\",\n        \"actions\": {\n          \"searchable_snapshot\": {\n            \"snapshot_repository\": \"found-snapshots\"\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"735d\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n----\n// end::ilm-policy-api-ex[]\n\n[discrete]\n[[create-component-templates]]\n=== Create component templates\n\n// tag::ds-create-component-templates[]\nA data stream requires a matching index template. In most cases, you compose\nthis index template using one or more component templates. You typically use\nseparate component templates for mappings and index settings. This lets you\nreuse the component templates in multiple index templates.\n\nWhen creating your component templates, include:\n\n* A <<date,`date`>> or <<date_nanos,`date_nanos`>> mapping for the `@timestamp`\nfield. If you don't specify a mapping, {es} maps `@timestamp` as a `date` field\nwith default options.\n\n* Your lifecycle policy in the `index.lifecycle.name` index setting.\n\n[TIP]\n====\nUse the {ecs-ref}[Elastic Common Schema (ECS)] when mapping your fields. ECS\nfields integrate with several {stack} features by default.\n\nIf you're unsure how to map your fields, use <<runtime-search-request,runtime\nfields>> to extract fields from <<mapping-unstructured-content,unstructured\ncontent>> at search time. For example, you can index a log message to a\n`wildcard` field and later extract IP addresses and other data from this field\nduring a search.\n====\n\nTo create a component template in {kib}, open the main menu and go to *Stack\nManagement > Index Management*. In the *Index Templates* view, click *Create\ncomponent template*.\n\nYou can also use the <<indices-component-template,create component template\nAPI>>.\n\n[source,console]\n----\n# Creates a component template for mappings\nPUT _component_template/my-mappings\n{\n  \"template\": {\n    \"mappings\": {\n      \"properties\": {\n        \"@timestamp\": {\n          \"type\": \"date\",\n          \"format\": \"date_optional_time||epoch_millis\"\n        },\n        \"message\": {\n          \"type\": \"wildcard\"\n        }\n      }\n    }\n  },\n  \"_meta\": {\n    \"description\": \"Mappings for @timestamp and message fields\",\n    \"my-custom-meta-field\": \"More arbitrary metadata\"\n  }\n}\n\n# Creates a component template for index settings\nPUT _component_template/my-settings\n{\n  \"template\": {\n    \"settings\": {\n      \"index.lifecycle.name\": \"my-lifecycle-policy\"\n    }\n  },\n  \"_meta\": {\n    \"description\": \"Settings for ILM\",\n    \"my-custom-meta-field\": \"More arbitrary metadata\"\n  }\n}\n----\n// TEST[continued]\n// end::ds-create-component-templates[]\n\n[discrete]\n[[create-index-template]]\n=== Create an index template\n\n// tag::ds-create-index-template[]\nUse your component templates to create an index template. Specify:\n\n* One or more index patterns that match the data stream's name. We recommend\nusing our {fleet-guide}/data-streams.html#data-streams-naming-scheme[data stream\nnaming scheme].\n\n* That the template is data stream enabled.\n\n* Any component templates that contain your mappings and index settings.\n\n* A priority higher than `200` to avoid collisions with built-in templates.\nSee <<avoid-index-pattern-collisions>>.\n\nTo create an index template in {kib}, open the main menu and go to *Stack\nManagement > Index Management*. In the *Index Templates* view, click *Create\ntemplate*.\n\nYou can also use the <<indices-put-template,create index template API>>.\nInclude the `data_stream` object to enable data streams.\n\n[source,console]\n----\nPUT _index_template/my-index-template\n{\n  \"index_patterns\": [\"my-data-stream*\"],\n  \"data_stream\": { },\n  \"composed_of\": [ \"my-mappings\", \"my-settings\" ],\n  \"priority\": 500,\n  \"_meta\": {\n    \"description\": \"Template for my time series data\",\n    \"my-custom-meta-field\": \"More arbitrary metadata\"\n  }\n}\n----\n// TEST[continued]\n// end::ds-create-index-template[]\n\n[discrete]\n[[create-data-stream]]\n=== Create the data stream\n\n// tag::ds-create-data-stream[]\n<<add-documents-to-a-data-stream,Indexing requests>> add documents to a data\nstream. These requests must use an `op_type` of `create`. Documents must include\na `@timestamp` field.\n\nTo automatically create your data stream, submit an indexing request that\ntargets the stream's name. This name must match one of your index template's\nindex patterns.\n\n[source,console]\n----\nPUT my-data-stream/_bulk\n{ \"create\":{ } }\n{ \"@timestamp\": \"2099-05-06T16:21:15.000Z\", \"message\": \"192.0.2.42 - - [06/May/2099:16:21:15 +0000] \\\"GET /images/bg.jpg HTTP/1.0\\\" 200 24736\" }\n{ \"create\":{ } }\n{ \"@timestamp\": \"2099-05-06T16:25:42.000Z\", \"message\": \"192.0.2.255 - - [06/May/2099:16:25:42 +0000] \\\"GET /favicon.ico HTTP/1.0\\\" 200 3638\" }\n\nPOST my-data-stream/_doc\n{\n  \"@timestamp\": \"2099-05-06T16:21:15.000Z\",\n  \"message\": \"192.0.2.42 - - [06/May/2099:16:21:15 +0000] \\\"GET /images/bg.jpg HTTP/1.0\\\" 200 24736\"\n}\n----\n// TEST[continued]\n// end::ds-create-data-stream[]\n\nYou can also manually create the stream using the\n<<indices-create-data-stream,create data stream API>>. The stream's name must\nstill match one of your template's index patterns.\n\n[source,console]\n----\nPUT _data_stream/my-data-stream\n----\n// TEST[continued]\n// TEST[s/my-data-stream/my-data-stream-alt/]\n\n[discrete]\n[[secure-data-stream]]\n=== Secure the data stream\n\ninclude::{es-ref-dir}/security/authorization/alias-privileges.asciidoc[tag=data-stream-security]\n\nFor an example, see <<data-stream-privileges>>.\n\n[discrete]\n[[convert-index-alias-to-data-stream]]\n=== Convert an index alias to a data stream\n\n// tag::time-series-alias-tip[]\nPrior to {es} 7.9, you'd typically use an\n<<manage-time-series-data-without-data-streams,index alias with a write index>>\nto manage time series data. Data streams replace this functionality, require\nless maintenance, and automatically integrate with <<data-tiers,data tiers>>.\n// end::time-series-alias-tip[]\n\nTo convert an index alias with a write index to a data stream with the same\nname, use the <<indices-migrate-to-data-stream,migrate to data stream API>>.\nDuring conversion, the alias\u2019s indices become hidden backing indices for the\nstream. The alias\u2019s write index becomes the stream\u2019s write index. The stream\nstill requires a matching index template with data stream enabled.\n\n////\n[source,console]\n----\nPOST idx1/_doc/\n{\n    \"message\" : \"testing\",\n    \"@timestamp\" : \"2099-01-01\"\n}\n\nPOST idx2/_doc/\n{\n    \"message\" : \"testing2\",\n    \"@timestamp\" : \"2099-01-01\"\n}\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"idx1\",\n        \"alias\": \"my-time-series-data\",\n        \"is_write_index\": true\n      }\n    },\n    {\n      \"add\": {\n        \"index\": \"idx2\",\n        \"alias\": \"my-time-series-data\"\n      }\n    }\n  ]\n}\n\nPUT _index_template/template\n{\n  \"index_patterns\": [\"my-time-series-data\"],\n  \"data_stream\": { }\n}\n----\n// TEST[continued]\n////\n\n[source,console]\n----\nPOST _data_stream/_migrate/my-time-series-data\n----\n// TEST[continued]\n\n[discrete]\n[[get-info-about-data-stream]]\n=== Get information about a data stream\n\nTo get information about a data stream in {kib}, open the main menu and go to\n*Stack Management > Index Management*. In the *Data Streams* view, click the\ndata stream's name.\n\nYou can also use the <<indices-get-data-stream,get data stream API>>.\n\n////\n[source,console]\n----\nPOST my-data-stream/_rollover/\n----\n// TEST[continued]\n////\n\n[source,console]\n----\nGET _data_stream/my-data-stream\n----\n// TEST[continued]\n\n[discrete]\n[[delete-data-stream]]\n=== Delete a data stream\n\nTo delete a data stream and its backing indices in {kib}, open the main menu and\ngo to *Stack Management > Index Management*. In the *Data Streams* view, click\nthe trash icon. The icon only displays if you have the `delete_index`\n<<security-privileges, security privilege>> for the data stream.\n\nYou can also use the <<indices-delete-data-stream,delete data stream API>>.\n\n[source,console]\n----\nDELETE _data_stream/my-data-stream\n----\n// TEST[continued]\n\n////\n[source,console]\n----\nDELETE _data_stream/*\nDELETE _index_template/*\nDELETE _component_template/my-*\nDELETE _ilm/policy/my-lifecycle-policy\n----\n// TEST[continued]\n////\n"
}