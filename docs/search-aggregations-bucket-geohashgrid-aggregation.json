{
    "meta": {
        "timestamp": "2024-11-01T02:49:25.184067",
        "size": 10254,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-geohashgrid-aggregation.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "search-aggregations-bucket-geohashgrid-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-bucket-geohashgrid-aggregation]]\n=== Geohash grid aggregation\n++++\n<titleabbrev>Geohash grid</titleabbrev>\n++++\n\nA multi-bucket aggregation that groups <<geo-point,`geo_point`>> and\n<<geo-shape,`geo_shape`>> values into buckets that represent a grid.\nThe resulting grid can be sparse and only contains cells that have matching data. Each cell is labeled using a {wikipedia}/Geohash[geohash] which is of user-definable precision.\n\n* High precision geohashes have a long string length and represent cells that cover only a small area.\n* Low precision geohashes have a short string length and represent cells that each cover a large area.\n\nGeohashes used in this aggregation can have a choice of precision between 1 and 12.\n\nWARNING: The highest-precision geohash of length 12 produces cells that cover less than a square metre of land and so high-precision requests can be very costly in terms of RAM and result sizes.\nPlease see the example below on how to first filter the aggregation to a smaller geographic area before requesting high-levels of detail.\n\nYou can only use `geohash_grid` to aggregate an explicitly mapped `geo_point` or\n`geo_shape` field. If the `geo_point` field contains an array, `geohash_grid`\naggregates all the array values.\n\n\n==== Simple low-precision request\n\n[source,console,id=geohashgrid-aggregation-low-precision-example]\n--------------------------------------------------\nPUT /museums\n{\n  \"mappings\": {\n    \"properties\": {\n      \"location\": {\n        \"type\": \"geo_point\"\n      }\n    }\n  }\n}\n\nPOST /museums/_bulk?refresh\n{\"index\":{\"_id\":1}}\n{\"location\": \"POINT (4.912350 52.374081)\", \"name\": \"NEMO Science Museum\"}\n{\"index\":{\"_id\":2}}\n{\"location\": \"POINT (4.901618 52.369219)\", \"name\": \"Museum Het Rembrandthuis\"}\n{\"index\":{\"_id\":3}}\n{\"location\": \"POINT (4.914722 52.371667)\", \"name\": \"Nederlands Scheepvaartmuseum\"}\n{\"index\":{\"_id\":4}}\n{\"location\": \"POINT (4.405200 51.222900)\", \"name\": \"Letterenhuis\"}\n{\"index\":{\"_id\":5}}\n{\"location\": \"POINT (2.336389 48.861111)\", \"name\": \"Mus\u00e9e du Louvre\"}\n{\"index\":{\"_id\":6}}\n{\"location\": \"POINT (2.327000 48.860000)\", \"name\": \"Mus\u00e9e d'Orsay\"}\n\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"large-grid\": {\n      \"geohash_grid\": {\n        \"field\": \"location\",\n        \"precision\": 3\n      }\n    }\n  }\n}\n--------------------------------------------------\n\nResponse:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n  \"large-grid\": {\n    \"buckets\": [\n      {\n        \"key\": \"u17\",\n        \"doc_count\": 3\n      },\n      {\n        \"key\": \"u09\",\n        \"doc_count\": 2\n      },\n      {\n        \"key\": \"u15\",\n        \"doc_count\": 1\n      }\n    ]\n  }\n}\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"_shards\": $body._shards,\"hits\":$body.hits,\"timed_out\":false,/]\n\n==== High-precision requests\n\nWhen requesting detailed buckets (typically for displaying a \"zoomed in\" map) a filter like <<query-dsl-geo-bounding-box-query,geo_bounding_box>> should be applied to narrow the subject area otherwise potentially millions of buckets will be created and returned.\n\n[source,console,id=geohashgrid-aggregation-high-precision-example]\n--------------------------------------------------\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"zoomed-in\": {\n      \"filter\": {\n        \"geo_bounding_box\": {\n          \"location\": {\n            \"top_left\": \"POINT (4.9 52.4)\",\n            \"bottom_right\": \"POINT (5.0 52.3)\"\n          }\n        }\n      },\n      \"aggregations\": {\n        \"zoom1\": {\n          \"geohash_grid\": {\n            \"field\": \"location\",\n            \"precision\": 8\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[continued]\n\nThe geohashes returned by the `geohash_grid` aggregation can be also used for zooming in. To zoom into the\nfirst geohash `u17` returned in the previous example, it should be specified as both `top_left` and `bottom_right` corner:\n\n[source,console]\n--------------------------------------------------\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"zoomed-in\": {\n      \"filter\": {\n        \"geo_bounding_box\": {\n          \"location\": {\n            \"top_left\": \"u17\",\n            \"bottom_right\": \"u17\"\n          }\n        }\n      },\n      \"aggregations\": {\n        \"zoom1\": {\n          \"geohash_grid\": {\n            \"field\": \"location\",\n            \"precision\": 8\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[continued]\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"zoomed-in\": {\n      \"doc_count\": 3,\n      \"zoom1\": {\n        \"buckets\": [\n          {\n            \"key\": \"u173zy3j\",\n            \"doc_count\": 1\n          },\n          {\n            \"key\": \"u173zvfz\",\n            \"doc_count\": 1\n          },\n          {\n            \"key\": \"u173zt90\",\n            \"doc_count\": 1\n          }\n        ]\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"_shards\": $body._shards,\"hits\":$body.hits,\"timed_out\":false,/]\n\nFor \"zooming in\" on the system that don't support geohashes, the bucket keys should be translated into bounding boxes using\none of available geohash libraries. For example, for javascript the https://github.com/sunng87/node-geohash[node-geohash] library\ncan be used:\n\n[source,js]\n--------------------------------------------------\nvar geohash = require('ngeohash');\n\n// bbox will contain [ 52.03125, 4.21875, 53.4375, 5.625 ]\n//                   [   minlat,  minlon,  maxlat, maxlon]\nvar bbox = geohash.decode_bbox('u17');\n--------------------------------------------------\n// NOTCONSOLE\n\n==== Requests with additional bounding box filtering\n\nThe `geohash_grid` aggregation supports an optional `bounds` parameter\nthat restricts the cells considered to those that intersects the\nbounds provided. The `bounds` parameter accepts the bounding box in\nall the same <<query-dsl-geo-bounding-box-query-accepted-formats,accepted formats>> of the\nbounds specified in the Geo Bounding Box Query. This bounding box can be used with or\nwithout an additional `geo_bounding_box` query filtering the points prior to aggregating.\nIt is an independent bounding box that can intersect with, be equal to, or be disjoint\nto any additional `geo_bounding_box` queries defined in the context of the aggregation.\n\n[source,console,id=geohashgrid-aggregation-with-bounds]\n--------------------------------------------------\nPOST /museums/_search?size=0\n{\n  \"aggregations\": {\n    \"tiles-in-bounds\": {\n      \"geohash_grid\": {\n        \"field\": \"location\",\n        \"precision\": 8,\n        \"bounds\": {\n          \"top_left\": \"POINT (4.21875 53.4375)\",\n          \"bottom_right\": \"POINT (5.625 52.03125)\"\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[continued]\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"tiles-in-bounds\": {\n      \"buckets\": [\n        {\n          \"key\": \"u173zy3j\",\n          \"doc_count\": 1\n        },\n        {\n          \"key\": \"u173zvfz\",\n          \"doc_count\": 1\n        },\n        {\n          \"key\": \"u173zt90\",\n          \"doc_count\": 1\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"_shards\": $body._shards,\"hits\":$body.hits,\"timed_out\":false,/]\n\n==== Cell dimensions at the equator\nThe table below shows the metric dimensions for cells covered by various string lengths of geohash.\nCell dimensions vary with latitude and so the table is for the worst-case scenario at the equator.\n\n[horizontal]\n*GeoHash length*::\t*Area width x height*\n1::\t    5,009.4km x 4,992.6km\n2::\t    1,252.3km x 624.1km\n3::\t    156.5km x 156km\n4::\t    39.1km x 19.5km\n5::\t    4.9km x 4.9km\n6::\t    1.2km x 609.4m\n7::\t    152.9m x 152.4m\n8::\t    38.2m x 19m\n9::\t    4.8m x 4.8m\n10::\t1.2m x 59.5cm\n11::\t14.9cm x 14.9cm\n12::\t3.7cm x 1.9cm\n\n\n[discrete]\n[role=\"xpack\"]\n==== Aggregating `geo_shape` fields\n\nAggregating on <<geo-shape>> fields works just as it does for points, except that a single\nshape can be counted for in multiple tiles. A shape will contribute to the count of matching values\nif any part of its shape intersects with that tile. Below is an image that demonstrates this:\n\n\nimage:images/spatial/geoshape_grid.png[]\n\n==== Options\n\n[horizontal]\nfield::         Mandatory. Field containing indexed geo-point or geo-shape \n                values. Must be explicitly mapped as a <<geo-point,`geo_point`>>\n                or a <<geo-shape,`geo_shape`>> field. If the field contains an \n                array, `geohash_grid` aggregates all array values.\n\nprecision::     Optional. The string length of the geohashes used to define\n                cells/buckets in the results. Defaults to 5.\n                The precision can either be defined in terms of the integer\n                precision levels mentioned above. Values outside of [1,12] will\n                be rejected.\n                Alternatively, the precision level can be approximated from a\n                distance measure like \"1km\", \"10m\". The precision level is\n                calculate such that cells will not exceed the specified\n                size (diagonal) of the required precision. When this would lead\n                to precision levels higher than the supported 12 levels,\n                (e.g. for distances <5.6cm) the value is rejected.\n\nbounds::        Optional. The bounding box to filter the points in the bucket.\n\nsize::          Optional. The maximum number of geohash buckets to return\n                (defaults to 10,000). When results are trimmed, buckets are\n                prioritised based on the volumes of documents they contain.\n\nshard_size::    Optional. To allow for more accurate counting of the top cells\n                returned in the final result the aggregation defaults to\n                returning `max(10,(size x number-of-shards))` buckets from each\n                shard. If this heuristic is undesirable, the number considered\n                from each shard can be over-ridden using this parameter.\n"
}