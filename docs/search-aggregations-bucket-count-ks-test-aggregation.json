{
    "meta": {
        "timestamp": "2024-11-01T02:49:24.575073",
        "size": 9433,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-count-ks-test-aggregation.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "search-aggregations-bucket-count-ks-test-aggregation",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[search-aggregations-bucket-count-ks-test-aggregation]]\n=== Bucket count K-S test correlation aggregation\n++++\n<titleabbrev>Bucket count K-S test</titleabbrev>\n++++\n\nA sibling pipeline aggregation which executes a two sample Kolmogorov\u2013Smirnov test\n(referred to as a \"K-S test\" from now on) against a provided distribution, and the\ndistribution implied by the documents counts in the configured sibling aggregation.\nSpecifically, for some metric, assuming that the percentile intervals of the metric are\nknown beforehand or have been computed by an aggregation, then one would use range\naggregation for the sibling to compute the p-value of the distribution difference between\nthe metric and the restriction of that metric to a subset of the documents. A natural use\ncase is if the sibling aggregation range aggregation nested in a terms aggregation, in\nwhich case one compares the overall distribution of metric to its restriction to each term.\n\n\n[[bucket-count-ks-test-agg-syntax]]\n==== Parameters\n\n`buckets_path`::\n(Required, string)\nPath to the buckets that contain one set of values to correlate. Must be a `_count` path\nFor syntax, see <<buckets-path-syntax>>.\n\n`alternative`::\n(Optional, list)\nA list of string values indicating which K-S test alternative to calculate.\nThe valid values are: \"greater\", \"less\", \"two_sided\". This parameter is key for\ndetermining the K-S statistic used when calculating the K-S test. Default value is\nall possible alternative hypotheses.\n\n`fractions`::\n(Optional, list)\nA list of doubles indicating the distribution of the samples with which to compare to the\n`buckets_path` results. In typical usage this is the overall proportion of documents in\neach bucket, which is compared with the actual document proportions in each bucket\nfrom the sibling aggregation counts. The default is to assume that overall documents\nare uniformly distributed on these buckets, which they would be if one used equal\npercentiles of a metric to define the bucket end points.\n\n`sampling_method`::\n(Optional, string)\nIndicates the sampling methodology when calculating the K-S test. Note, this is sampling\nof the returned values. This determines the cumulative distribution function (CDF) points\nused comparing the two samples. Default is `upper_tail`, which emphasizes the upper\nend of the CDF points. Valid options are: `upper_tail`, `uniform`, and `lower_tail`.\n\n==== Syntax\n\nA `bucket_count_ks_test` aggregation looks like this in isolation:\n\n[source,js]\n--------------------------------------------------\n{\n  \"bucket_count_ks_test\": {\n    \"buckets_path\": \"range_values>_count\", <1>\n    \"alternative\": [\"less\", \"greater\", \"two_sided\"], <2>\n    \"sampling_method\": \"upper_tail\" <3>\n  }\n}\n--------------------------------------------------\n// NOTCONSOLE\n<1> The buckets containing the values to test against.\n<2> The alternatives to calculate.\n<3> The sampling method for the K-S statistic.\n\n\n[[bucket-count-ks-test-agg-example]]\n==== Example\n\nThe following snippet runs the `bucket_count_ks_test` on the individual terms in the field `version` against a uniform distribution.\nThe uniform distribution reflects the `latency` percentile buckets. Not shown is the pre-calculation of the `latency` indicator values,\nwhich was done utilizing the\n<<search-aggregations-metrics-percentile-aggregation,percentiles>> aggregation.\n\nThis example is only using the deciles of `latency`.\n\n[source,console]\n-------------------------------------------------\nPOST correlate_latency/_search?size=0&filter_path=aggregations\n{\n  \"aggs\": {\n    \"buckets\": {\n      \"terms\": { <1>\n        \"field\": \"version\",\n        \"size\": 2\n      },\n      \"aggs\": {\n        \"latency_ranges\": {\n          \"range\": { <2>\n            \"field\": \"latency\",\n            \"ranges\": [\n              { \"to\": 0 },\n              { \"from\": 0, \"to\": 105 },\n              { \"from\": 105, \"to\": 225 },\n              { \"from\": 225, \"to\": 445 },\n              { \"from\": 445, \"to\": 665 },\n              { \"from\": 665, \"to\": 885 },\n              { \"from\": 885, \"to\": 1115 },\n              { \"from\": 1115, \"to\": 1335 },\n              { \"from\": 1335, \"to\": 1555 },\n              { \"from\": 1555, \"to\": 1775 },\n              { \"from\": 1775 }\n            ]\n          }\n        },\n        \"ks_test\": { <3>\n          \"bucket_count_ks_test\": {\n            \"buckets_path\": \"latency_ranges>_count\",\n            \"alternative\": [\"less\", \"greater\", \"two_sided\"]\n          }\n        }\n      }\n    }\n  }\n}\n-------------------------------------------------\n// TEST[setup:correlate_latency]\n\n<1> The term buckets containing a range aggregation and the bucket correlation aggregation. Both are utilized to calculate\n    the correlation of the term values with the latency.\n<2> The range aggregation on the latency field. The ranges were created referencing the percentiles of the latency field.\n<3> The bucket count K-S test aggregation that tests if the bucket counts comes from the same distribution as `fractions`;\n    where `fractions` is a uniform distribution.\n\nAnd the following may be the response:\n\n[source,console-result]\n----\n{\n  \"aggregations\" : {\n    \"buckets\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"1.0\",\n          \"doc_count\" : 100,\n          \"latency_ranges\" : {\n            \"buckets\" : [\n              {\n                \"key\" : \"*-0.0\",\n                \"to\" : 0.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"0.0-105.0\",\n                \"from\" : 0.0,\n                \"to\" : 105.0,\n                \"doc_count\" : 1\n              },\n              {\n                \"key\" : \"105.0-225.0\",\n                \"from\" : 105.0,\n                \"to\" : 225.0,\n                \"doc_count\" : 9\n              },\n              {\n                \"key\" : \"225.0-445.0\",\n                \"from\" : 225.0,\n                \"to\" : 445.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"445.0-665.0\",\n                \"from\" : 445.0,\n                \"to\" : 665.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"665.0-885.0\",\n                \"from\" : 665.0,\n                \"to\" : 885.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"885.0-1115.0\",\n                \"from\" : 885.0,\n                \"to\" : 1115.0,\n                \"doc_count\" : 10\n              },\n              {\n                \"key\" : \"1115.0-1335.0\",\n                \"from\" : 1115.0,\n                \"to\" : 1335.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"1335.0-1555.0\",\n                \"from\" : 1335.0,\n                \"to\" : 1555.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"1555.0-1775.0\",\n                \"from\" : 1555.0,\n                \"to\" : 1775.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"1775.0-*\",\n                \"from\" : 1775.0,\n                \"doc_count\" : 20\n              }\n            ]\n          },\n          \"ks_test\" : {\n            \"less\" : 2.248673241788478E-4,\n            \"greater\" : 1.0,\n            \"two_sided\" : 5.791639181800257E-4\n          }\n        },\n        {\n          \"key\" : \"2.0\",\n          \"doc_count\" : 100,\n          \"latency_ranges\" : {\n            \"buckets\" : [\n              {\n                \"key\" : \"*-0.0\",\n                \"to\" : 0.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"0.0-105.0\",\n                \"from\" : 0.0,\n                \"to\" : 105.0,\n                \"doc_count\" : 19\n              },\n              {\n                \"key\" : \"105.0-225.0\",\n                \"from\" : 105.0,\n                \"to\" : 225.0,\n                \"doc_count\" : 11\n              },\n              {\n                \"key\" : \"225.0-445.0\",\n                \"from\" : 225.0,\n                \"to\" : 445.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"445.0-665.0\",\n                \"from\" : 445.0,\n                \"to\" : 665.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"665.0-885.0\",\n                \"from\" : 665.0,\n                \"to\" : 885.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"885.0-1115.0\",\n                \"from\" : 885.0,\n                \"to\" : 1115.0,\n                \"doc_count\" : 10\n              },\n              {\n                \"key\" : \"1115.0-1335.0\",\n                \"from\" : 1115.0,\n                \"to\" : 1335.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"1335.0-1555.0\",\n                \"from\" : 1335.0,\n                \"to\" : 1555.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"1555.0-1775.0\",\n                \"from\" : 1555.0,\n                \"to\" : 1775.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"1775.0-*\",\n                \"from\" : 1775.0,\n                \"doc_count\" : 0\n              }\n            ]\n          },\n          \"ks_test\" : {\n            \"less\" : 0.9642895789647244,\n            \"greater\" : 4.58718174664754E-9,\n            \"two_sided\" : 5.916656831139733E-9\n          }\n        }\n      ]\n    }\n  }\n}\n----\n"
}