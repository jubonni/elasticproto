{
    "meta": {
        "size": 12762,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-rate-aggregation.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "search-aggregations-metrics-rate-aggregation",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[search-aggregations-metrics-rate-aggregation]]\n=== Rate aggregation\n++++\n<titleabbrev>Rate</titleabbrev>\n++++\n\nA `rate` metrics aggregation can be used only inside a `date_histogram` or `composite` aggregation. It calculates a rate of documents\nor a field in each bucket. The field values can be extracted from specific numeric or\n<<histogram,histogram fields>> in the documents.\n\nNOTE: For `composite` aggregations, there must be exactly one `date_histogram` source for the `rate` aggregation to be supported.\n\n==== Syntax\n\nA `rate` aggregation looks like this in isolation:\n\n[source,js]\n--------------------------------------------------\n{\n  \"rate\": {\n    \"unit\": \"month\",\n    \"field\": \"requests\"\n  }\n}\n--------------------------------------------------\n// NOTCONSOLE\n\nThe following request will group all sales records into monthly buckets and then convert the number of sales transactions in each bucket\ninto per annual sales rate.\n\n[source,console]\n--------------------------------------------------\nGET sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"by_date\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"  <1>\n      },\n      \"aggs\": {\n        \"my_rate\": {\n          \"rate\": {\n            \"unit\": \"year\"  <2>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n<1> Histogram is grouped by month.\n<2> But the rate is converted into annual rate.\n\nThe response will return the annual rate of transactions in each bucket. Since there are 12 months per year, the annual rate will\nbe automatically calculated by multiplying the monthly rate by 12.\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\" : {\n    \"by_date\" : {\n      \"buckets\" : [\n        {\n          \"key_as_string\" : \"2015/01/01 00:00:00\",\n          \"key\" : 1420070400000,\n          \"doc_count\" : 3,\n          \"my_rate\" : {\n            \"value\" : 36.0\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/02/01 00:00:00\",\n          \"key\" : 1422748800000,\n          \"doc_count\" : 2,\n          \"my_rate\" : {\n            \"value\" : 24.0\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/03/01 00:00:00\",\n          \"key\" : 1425168000000,\n          \"doc_count\" : 2,\n          \"my_rate\" : {\n            \"value\" : 24.0\n          }\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n\nInstead of counting the number of documents, it is also possible to calculate a sum of all values of the fields in the documents in each\nbucket or the number of values in each bucket. The following request will group all sales records into monthly bucket and than calculate\nthe total monthly sales and convert them into average daily sales.\n\n[source,console]\n--------------------------------------------------\nGET sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"by_date\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"  <1>\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"rate\": {\n            \"field\": \"price\", <2>\n            \"unit\": \"day\"  <3>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n<1> Histogram is grouped by month.\n<2> Calculate sum of all sale prices\n<3> Convert to average daily sales\n\nThe response will contain the average daily sale prices for each month.\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\" : {\n    \"by_date\" : {\n      \"buckets\" : [\n        {\n          \"key_as_string\" : \"2015/01/01 00:00:00\",\n          \"key\" : 1420070400000,\n          \"doc_count\" : 3,\n          \"avg_price\" : {\n            \"value\" : 17.741935483870968\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/02/01 00:00:00\",\n          \"key\" : 1422748800000,\n          \"doc_count\" : 2,\n          \"avg_price\" : {\n            \"value\" : 2.142857142857143\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/03/01 00:00:00\",\n          \"key\" : 1425168000000,\n          \"doc_count\" : 2,\n          \"avg_price\" : {\n            \"value\" : 12.096774193548388\n          }\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n\nYou can also take advantage of `composite` aggregations to calculate the average daily sale price for each item in\nyour inventory\n\n[source,console]\n--------------------------------------------------\nGET sales/_search?filter_path=aggregations&size=0\n{\n  \"aggs\": {\n    \"buckets\": {\n      \"composite\": { <1>\n        \"sources\": [\n          {\n            \"month\": {\n              \"date_histogram\": { <2>\n                \"field\": \"date\",\n                \"calendar_interval\": \"month\"\n              }\n            }\n          },\n          {\n            \"type\": { <3>\n              \"terms\": {\n                \"field\": \"type\"\n              }\n            }\n          }\n        ]\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"rate\": {\n            \"field\": \"price\", <4>\n            \"unit\": \"day\" <5>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n<1> Composite aggregation with a date histogram source\n    and a source for the item type.\n<2> The date histogram source grouping monthly\n<3> The terms source grouping for each sale item type\n<4> Calculate sum of all sale prices, per month and item\n<5> Convert to average daily sales per item\n\nThe response will contain the average daily sale prices for each month per item.\n\n[source,console-result]\n--------------------------------------------------\n{\n  \"aggregations\" : {\n    \"buckets\" : {\n      \"after_key\" : {\n        \"month\" : 1425168000000,\n        \"type\" : \"t-shirt\"\n      },\n      \"buckets\" : [\n        {\n          \"key\" : {\n            \"month\" : 1420070400000,\n            \"type\" : \"bag\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 4.838709677419355\n          }\n        },\n        {\n          \"key\" : {\n            \"month\" : 1420070400000,\n            \"type\" : \"hat\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 6.451612903225806\n          }\n        },\n        {\n          \"key\" : {\n            \"month\" : 1420070400000,\n            \"type\" : \"t-shirt\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 6.451612903225806\n          }\n        },\n        {\n          \"key\" : {\n            \"month\" : 1422748800000,\n            \"type\" : \"hat\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 1.7857142857142858\n          }\n        },\n        {\n          \"key\" : {\n            \"month\" : 1422748800000,\n            \"type\" : \"t-shirt\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 0.35714285714285715\n          }\n        },\n        {\n          \"key\" : {\n            \"month\" : 1425168000000,\n            \"type\" : \"hat\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 6.451612903225806\n          }\n        },\n        {\n          \"key\" : {\n            \"month\" : 1425168000000,\n            \"type\" : \"t-shirt\"\n          },\n          \"doc_count\" : 1,\n          \"avg_price\" : {\n            \"value\" : 5.645161290322581\n          }\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n\nBy adding the `mode` parameter with the value `value_count`, we can change the calculation from `sum` to the number of values of the field:\n\n[source,console]\n--------------------------------------------------\nGET sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"by_date\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"  <1>\n      },\n      \"aggs\": {\n        \"avg_number_of_sales_per_year\": {\n          \"rate\": {\n            \"field\": \"price\", <2>\n            \"unit\": \"year\",  <3>\n            \"mode\": \"value_count\" <4>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n<1> Histogram is grouped by month.\n<2> Calculate number of all sale prices\n<3> Convert to annual counts\n<4> Changing the mode to value count\n\nThe response will contain the average daily sale prices for each month.\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\" : {\n    \"by_date\" : {\n      \"buckets\" : [\n        {\n          \"key_as_string\" : \"2015/01/01 00:00:00\",\n          \"key\" : 1420070400000,\n          \"doc_count\" : 3,\n          \"avg_number_of_sales_per_year\" : {\n            \"value\" : 36.0\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/02/01 00:00:00\",\n          \"key\" : 1422748800000,\n          \"doc_count\" : 2,\n          \"avg_number_of_sales_per_year\" : {\n            \"value\" : 24.0\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/03/01 00:00:00\",\n          \"key\" : 1425168000000,\n          \"doc_count\" : 2,\n          \"avg_number_of_sales_per_year\" : {\n            \"value\" : 24.0\n          }\n        }\n      ]\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n\nBy default `sum` mode is used.\n\n`\"mode\": \"sum\"`:: calculate the sum of all values field\n`\"mode\": \"value_count\"`:: use the number of values in the field\n\n==== Relationship between bucket sizes and rate\n\nThe `rate` aggregation supports all rate that can be used <<calendar_intervals,calendar_intervals parameter>> of `date_histogram`\naggregation. The specified rate should compatible with the `date_histogram` aggregation interval, i.e. it should be possible to\nconvert the bucket size into the rate. By default the interval of the `date_histogram` is used.\n\n`\"rate\": \"second\"`:: compatible with all intervals\n`\"rate\": \"minute\"`:: compatible with all intervals\n`\"rate\": \"hour\"`:: compatible with all intervals\n`\"rate\": \"day\"`:: compatible with all intervals\n`\"rate\": \"week\"`:: compatible with all intervals\n`\"rate\": \"month\"`:: compatible with only with `month`, `quarter` and `year` calendar intervals\n`\"rate\": \"quarter\"`:: compatible with only with `month`, `quarter` and `year` calendar intervals\n`\"rate\": \"year\"`:: compatible with only with `month`, `quarter` and `year` calendar intervals\n\nThere is also an additional limitations if the date histogram is not a direct parent of the rate histogram. In this case both rate interval\nand histogram interval have to be in the same group: [`second`, ` minute`, `hour`, `day`, `week`] or [`month`, `quarter`, `year`]. For\nexample, if the date histogram is `month` based, only rate intervals of `month`, `quarter` or `year` are supported. If the date histogram\nis `day` based, only  `second`, ` minute`, `hour`, `day`, and `week` rate intervals are supported.\n\n==== Script\n\nIf you need to run the aggregation against values that aren't indexed, run the\naggregation on a <<runtime,runtime field>>. For example, if we need to adjust\nour prices before calculating rates:\n\n[source,console]\n----\nGET sales/_search\n{\n  \"size\": 0,\n  \"runtime_mappings\": {\n    \"price.adjusted\": {\n      \"type\": \"double\",\n      \"script\": {\n        \"source\": \"emit(doc['price'].value * params.adjustment)\",\n        \"params\": {\n          \"adjustment\": 0.9\n        }\n      }\n    }\n  },\n  \"aggs\": {\n    \"by_date\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"rate\": {\n            \"field\": \"price.adjusted\"\n          }\n        }\n      }\n    }\n  }\n}\n----\n// TEST[setup:sales]\n\n[source,console-result]\n----\n{\n  ...\n  \"aggregations\" : {\n    \"by_date\" : {\n      \"buckets\" : [\n        {\n          \"key_as_string\" : \"2015/01/01 00:00:00\",\n          \"key\" : 1420070400000,\n          \"doc_count\" : 3,\n          \"avg_price\" : {\n            \"value\" : 495.0\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/02/01 00:00:00\",\n          \"key\" : 1422748800000,\n          \"doc_count\" : 2,\n          \"avg_price\" : {\n            \"value\" : 54.0\n          }\n        },\n        {\n          \"key_as_string\" : \"2015/03/01 00:00:00\",\n          \"key\" : 1425168000000,\n          \"doc_count\" : 2,\n          \"avg_price\" : {\n            \"value\" : 337.5\n          }\n        }\n      ]\n    }\n  }\n}\n----\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n"
}