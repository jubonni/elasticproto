{
    "meta": {
        "timestamp": "2024-11-01T03:02:52.357578",
        "size": 5304,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-delegate-pki-authentication.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "security-api-delegate-pki-authentication",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[security-api-delegate-pki-authentication]]\n=== Delegate PKI authentication API\n++++\n<titleabbrev>Delegate PKI authentication</titleabbrev>\n++++\n\nImplements the exchange of an _X509Certificate_ chain into an {es} access\ntoken.\n\n[[security-api-delegate-pki-authentication-request]]\n==== {api-request-title}\n\n`POST /_security/delegate_pki`\n\n[[security-api-delegate-pki-authentication-prereqs]]\n==== {api-prereq-title}\n\n* To call this API, the (proxy) user must have the `delegate_pki` or the `all`\ncluster privilege. The `kibana_system` built-in role already grants this\nprivilege. See <<security-privileges>>.\n\n[[security-api-delegate-pki-authentication-desc]]\n==== {api-description-title}\n\nThis API implements the exchange of an _X509Certificate_ chain for an {es}\naccess token. The certificate chain is validated, according to RFC 5280, by\nsequentially considering the trust configuration of every installed PKI realm\nthat has `delegation.enabled` set to `true` (default is `false`). A\nsuccessfully trusted client certificate is also subject to the validation of\nthe subject distinguished name according to that respective's realm\n`username_pattern`.\n\nThis API is called by *smart* and *trusted* proxies, such as {kib}, which\nterminate the user's TLS session but still want to authenticate the user\nby using a PKI realm--as if the user connected directly to {es}. For more\ndetails, see <<pki-realm-for-proxied-clients>>.\n\nIMPORTANT: The association between the subject public key in the target\ncertificate and the corresponding private key is *not* validated. This is part\nof the TLS authentication process and it is delegated to the proxy that calls\nthis API. The proxy is *trusted* to have performed the TLS authentication and\nthis API translates that authentication into an {es} access token.\n\n[[security-api-delegate-pki-authentication-request-body]]\n==== {api-request-body-title}\n\n`x509_certificate_chain`::\n(Required, list of strings) The _X509Certificate_ chain, which is represented as\nan ordered string array. Each string in the array is a base64-encoded\n(Section 4 of RFC4648 - not base64url-encoded) of the certificate's DER encoding.\n+\nThe first element is the target certificate contains the subject distinguished\nname that is requesting access. This may be followed by additional certificates;\neach subsequent certificate is used to certify the previous one.\n\n\n[[security-api-delegate-pki-authentication-response-body]]\n==== {api-response-body-title}\n\n`access_token`::\n(string) An access token associated to the subject distinguished name of the\nclient's certificate.\n\n`expires_in`::\n(time units) The amount of time (in seconds) that the token expires in.\n\n`type`::\n(string) The type of token.\n\n[[security-api-delegate-pki-authentication-example]]\n==== {api-examples-title}\n\nThe following is an example request:\n\n[source,console]\n------------------------------------------------------------\nPOST /_security/delegate_pki\n{\n  \"x509_certificate_chain\": [\"MIIDeDCCAmCgAwIBAgIUBzj/nGGKxP2iXawsSquHmQjCJmMwDQYJKoZIhvcNAQELBQAwUzErMCkGA1UEAxMiRWxhc3RpY3NlYXJjaCBUZXN0IEludGVybWVkaWF0ZSBDQTEWMBQGA1UECxMNRWxhc3RpY3NlYXJjaDEMMAoGA1UEChMDb3JnMB4XDTIzMDcxODE5MjkwNloXDTQzMDcxMzE5MjkwNlowSjEiMCAGA1UEAxMZRWxhc3RpY3NlYXJjaCBUZXN0IENsaWVudDEWMBQGA1UECxMNRWxhc3RpY3NlYXJjaDEMMAoGA1UEChMDb3JnMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAllHL4pQkkfwAm/oLkxYYO+r950DEy1bjH+4viCHzNADLCTWO+lOZJVlNx7QEzJE3QGMdif9CCBBxQFMapA7oUFCLq84fPSQQu5AnvvbltVD9nwVtCs+9ZGDjMKsz98RhSLMFIkxdxi6HkQ3Lfa4ZSI4lvba4oo+T/GveazBDS+NgmKyq00EOXt3tWi1G9vEVItommzXWfv0agJWzVnLMldwkPqsw0W7zrpyT7FZS4iLbQADGceOW8fiauOGMkscu9zAnDR/SbWl/chYioQOdw6ndFLn1YIFPd37xL0WsdsldTpn0vH3YfzgLMffT/3P6YlwBegWzsx6FnM/93Ecb4wIDAQABo00wSzAJBgNVHRMEAjAAMB0GA1UdDgQWBBQKNRwjW+Ad/FN1Rpoqme/5+jrFWzAfBgNVHSMEGDAWgBRcya0c0x/PaI7MbmJVIylWgLqXNjANBgkqhkiG9w0BAQsFAAOCAQEACZ3PF7Uqu47lplXHP6YlzYL2jL0D28hpj5lGtdha4Muw1m/BjDb0Pu8l0NQ1z3AP6AVcvjNDkQq6Y5jeSz0bwQlealQpYfo7EMXjOidrft1GbqOMFmTBLpLA9SvwYGobSTXWTkJzonqVaTcf80HpMgM2uEhodwTcvz6v1WEfeT/HMjmdIsq4ImrOL9RNrcZG6nWfw0HR3JNOgrbfyEztEI471jHznZ336OEcyX7gQuvHE8tOv5+oD1d7s3Xg1yuFp+Ynh+FfOi3hPCuaHA+7F6fLmzMDLVUBAllugst1C3U+L/paD7tqIa4ka+KNPCbSfwazmJrt4XNiivPR4hwH5g==\"] <1>\n}\n------------------------------------------------------------\n<1>  A one element certificate chain.\n\nWhich returns the following response:\n\n[source,console-result]\n--------------------------------------------------\n{\n  \"access_token\" : \"dGhpcyBpcyBub3QgYSByZWFsIHRva2VuIGJ1dCBpdCBpcyBvbmx5IHRlc3QgZGF0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==\",\n  \"type\" : \"Bearer\",\n  \"expires_in\" : 1200,\n  \"authentication\" : {\n    \"username\" : \"Elasticsearch Test Client\",\n    \"roles\" : [ ],\n    \"full_name\" : null,\n    \"email\" : null,\n    \"metadata\" : {\n      \"pki_dn\" : \"O=org, OU=Elasticsearch, CN=Elasticsearch Test Client\",\n      \"pki_delegated_by_user\" : \"test_admin\",\n      \"pki_delegated_by_realm\" : \"file\"\n    },\n    \"enabled\" : true,\n    \"authentication_realm\" : {\n      \"name\" : \"pki1\",\n      \"type\" : \"pki\"\n    },\n    \"lookup_realm\" : {\n      \"name\" : \"pki1\",\n      \"type\" : \"pki\"\n    },\n    \"authentication_type\" : \"realm\"\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/dGhpcyBpcyBub3QgYSByZWFsIHRva2VuIGJ1dCBpdCBpcyBvbmx5IHRlc3QgZGF0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==/$body.access_token/]\n"
}