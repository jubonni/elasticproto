{
    "meta": {
        "timestamp": "2024-11-01T03:07:10.142280",
        "size": 3833,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-query.html",
        "type": "documentation",
        "role": [],
        "has_code": false,
        "title": "query-dsl-script-query",
        "version": "8.15"
    },
    "doc": "[[query-dsl-script-query]]\n=== Script query\n++++\n<titleabbrev>Script</titleabbrev>\n++++\n\nNOTE: <<runtime,Runtime fields>> provide a very similar feature that is\n      more flexible. You write a script to create field values and they\n      are available everywhere, such as <<search-fields, `fields`>>,\n      <<query-dsl, all queries>>, and <<search-aggregations, aggregations>>.\n\n\nFilters documents based on a provided <<modules-scripting-using,script>>. The\n`script` query is typically used in a <<query-filter-context,filter context>>.\n\nWARNING: Using scripts can result in slower search speeds. See\n<<scripts-and-search-speed>>.\n\n\n[[script-query-ex-request]]\n==== Example request\n\n[source,console]\n----\nGET /_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"script\": {\n          \"script\": \"\"\"\n            double amount = doc['amount'].value;\n            if (doc['type'].value == 'expense') {\n              amount *= -1;\n            }\n            return amount < 10;\n          \"\"\"\n        }\n      }\n    }\n  }\n}\n----\n// TEST[setup:ledger]\n// TEST[s/_search/_search?filter_path=hits.hits&sort=amount/]\n\n////\n[source,console-result]\n----\n{\n  \"hits\": {\n    \"hits\": [\n      {\n        \"_id\": $body.hits.hits.0._id,\n        \"_index\": $body.hits.hits.0._index,\n        \"_score\": null,\n        \"_source\": $body.hits.hits.0._source,\n        \"sort\": [10.0]\n      },\n      {\n        \"_id\": $body.hits.hits.1._id,\n        \"_index\": $body.hits.hits.1._index,\n        \"_score\": null,\n        \"_source\": $body.hits.hits.1._source,\n        \"sort\": [50.0]\n      },\n      {\n        \"_id\": $body.hits.hits.2._id,\n        \"_index\": $body.hits.hits.2._index,\n        \"_score\": null,\n        \"_source\": $body.hits.hits.2._source,\n        \"sort\": [50.0]\n      }\n    ]\n  }\n}\n----\n////\n\nYou can achieve the same results in a search\nquery by using runtime fields. Use the\n<<search-fields,`fields`>> parameter on the \n`_search` API to fetch values as part of the\nsame query:\n\n[source,console]\n----\nGET /_search\n{\n  \"runtime_mappings\": {\n    \"amount.signed\": {\n      \"type\": \"double\",\n      \"script\": \"\"\"\n        double amount = doc['amount'].value;\n        if (doc['type'].value == 'expense') {\n          amount *= -1;\n        }\n        emit(amount);\n      \"\"\"\n    }\n  },\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"range\": {\n          \"amount.signed\": { \"lt\": 10 }\n        }\n      }\n    }\n  },\n  \"fields\": [{\"field\": \"amount.signed\"}]\n}\n----\n// TEST[setup:ledger]\n// TEST[s/_search/_search?filter_path=hits.hits.fields&sort=amount.signed:desc/]\n\n////\n[source,console-result]\n----\n{\n  \"hits\": {\n    \"hits\": [\n      {\n        \"fields\": {\"amount.signed\": [-10.0]}\n      },\n      {\n        \"fields\": {\"amount.signed\": [-50.0]}\n      },\n      {\n        \"fields\": {\"amount.signed\": [-50.0]}\n      }\n    ]\n  }\n}\n----\n////\n\n[[script-top-level-params]]\n==== Top-level parameters for `script`\n\n`script`::\n(Required, <<modules-scripting-using, script object>>) Contains a script to run\nas a query. This script must return a boolean value, `true` or `false`.\n\n[[script-query-notes]]\n==== Notes\n\n[[script-query-custom-params]]\n===== Custom Parameters\n\nLike <<query-filter-context,filters>>, scripts are cached for faster execution.\nIf you frequently change the arguments of a script, we recommend you store them\nin the script's `params` parameter. For example:\n\n[source,console]\n----\nGET /_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"script\": {\n          \"script\": {\n            \"source\": \"doc['num1'].value > params.param1\",\n            \"lang\": \"painless\",\n            \"params\": {\n              \"param1\": 5\n            }\n          }\n        }\n      }\n    }\n  }\n}\n----\n\n===== Allow expensive queries\nScript queries will not be executed if <<query-dsl-allow-expensive-queries, `search.allow_expensive_queries`>>\nis set to false.\n"
}