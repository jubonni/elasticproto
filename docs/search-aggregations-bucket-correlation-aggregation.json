{
    "meta": {
        "timestamp": "2024-11-01T02:49:24.574066",
        "size": 9163,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-correlation-aggregation.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "search-aggregations-bucket-correlation-aggregation",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[search-aggregations-bucket-correlation-aggregation]]\n=== Bucket correlation aggregation\n++++\n<titleabbrev>Bucket correlation</titleabbrev>\n++++\n\nA sibling pipeline aggregation which executes a correlation function on the\nconfigured sibling multi-bucket aggregation.\n\n\n[[bucket-correlation-agg-syntax]]\n==== Parameters\n\n`buckets_path`::\n(Required, string)\nPath to the buckets that contain one set of values to correlate.\nFor syntax, see <<buckets-path-syntax>>.\n\n`function`::\n(Required, object)\nThe correlation function to execute.\n+\n.Properties of `function`\n[%collapsible%open]\n====\n`count_correlation`:::\n(Required^*^, object)\nThe configuration to calculate a count correlation. This function is designed for\ndetermining the correlation of a term value and a given metric. Consequently, it\nneeds to meet the following requirements.\n+\n--\n\n* The `buckets_path` must point to a `_count` metric.\n* The total count of all the `bucket_path` count values must be less than or equal to `indicator.doc_count`.\n* When utilizing this function, an initial calculation to gather the required `indicator` values is required.\n--\n+\n.Properties of `count_correlation`\n[%collapsible%open]\n=====\n`indicator`:::\n(Required, object)\nThe indicator with which to correlate the configured `bucket_path` values.\n+\n.Properties of `indicator`\n[%collapsible%open]\n======\n`doc_count`:::\n(Required, integer)\nThe total number of documents that initially created the `expectations`. It's required to be greater than or equal to the sum\nof all values in the `buckets_path` as this is the originating superset of data to which the term values are correlated.\n\n`expectations`:::\n(Required, array)\nAn array of numbers with which to correlate the configured `bucket_path` values. The length of this value must always equal\nthe number of buckets returned by the `bucket_path`.\n\n`fractions`:::\n(Optional, array)\nAn array of fractions to use when averaging and calculating variance. This should be used if the pre-calculated data and the\n`buckets_path` have known gaps. The length of `fractions`, if provided, must equal `expectations`.\n======\n=====\n====\n\n==== Syntax\n\nA `bucket_correlation` aggregation looks like this in isolation:\n\n[source,js]\n--------------------------------------------------\n{\n  \"bucket_correlation\": {\n    \"buckets_path\": \"range_values>_count\", <1>\n    \"function\": {\n      \"count_correlation\": { <2>\n        \"indicator\": {\n          \"expectations\": [...],\n          \"doc_count\": 10000\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// NOTCONSOLE\n<1> The buckets containing the values to correlate against.\n<2> The correlation function definition.\n\n\n[[bucket-correlation-agg-example]]\n==== Example\n\nThe following snippet correlates the individual terms in the field `version` with the `latency` metric. Not shown\nis the pre-calculation of the `latency` indicator values, which was done utilizing the\n<<search-aggregations-metrics-percentile-aggregation,percentiles>> aggregation.\n\nThis example is only using the 10s percentiles.\n\n[source,console]\n-------------------------------------------------\nPOST correlate_latency/_search?size=0&filter_path=aggregations\n{\n  \"aggs\": {\n    \"buckets\": {\n      \"terms\": { <1>\n        \"field\": \"version\",\n        \"size\": 2\n      },\n      \"aggs\": {\n        \"latency_ranges\": {\n          \"range\": { <2>\n            \"field\": \"latency\",\n            \"ranges\": [\n              { \"to\": 0.0 },\n              { \"from\": 0, \"to\": 105 },\n              { \"from\": 105, \"to\": 225 },\n              { \"from\": 225, \"to\": 445 },\n              { \"from\": 445, \"to\": 665 },\n              { \"from\": 665, \"to\": 885 },\n              { \"from\": 885, \"to\": 1115 },\n              { \"from\": 1115, \"to\": 1335 },\n              { \"from\": 1335, \"to\": 1555 },\n              { \"from\": 1555, \"to\": 1775 },\n              { \"from\": 1775 }\n            ]\n          }\n        },\n        \"bucket_correlation\": { <3>\n          \"bucket_correlation\": {\n            \"buckets_path\": \"latency_ranges>_count\",\n            \"function\": {\n              \"count_correlation\": {\n                \"indicator\": {\n                   \"expectations\": [0, 52.5, 165, 335, 555, 775, 1000, 1225, 1445, 1665, 1775],\n                   \"doc_count\": 200\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n-------------------------------------------------\n// TEST[setup:correlate_latency]\n\n<1> The term buckets containing a range aggregation and the bucket correlation aggregation. Both are utilized to calculate\n    the correlation of the term values with the latency.\n<2> The range aggregation on the latency field. The ranges were created referencing the percentiles of the latency field.\n<3> The bucket correlation aggregation that calculates the correlation of the number of term values within each range\n    and the previously calculated indicator values.\n\nAnd the following may be the response:\n\n[source,console-result]\n----\n{\n  \"aggregations\" : {\n    \"buckets\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"1.0\",\n          \"doc_count\" : 100,\n          \"latency_ranges\" : {\n            \"buckets\" : [\n              {\n                \"key\" : \"*-0.0\",\n                \"to\" : 0.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"0.0-105.0\",\n                \"from\" : 0.0,\n                \"to\" : 105.0,\n                \"doc_count\" : 1\n              },\n              {\n                \"key\" : \"105.0-225.0\",\n                \"from\" : 105.0,\n                \"to\" : 225.0,\n                \"doc_count\" : 9\n              },\n              {\n                \"key\" : \"225.0-445.0\",\n                \"from\" : 225.0,\n                \"to\" : 445.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"445.0-665.0\",\n                \"from\" : 445.0,\n                \"to\" : 665.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"665.0-885.0\",\n                \"from\" : 665.0,\n                \"to\" : 885.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"885.0-1115.0\",\n                \"from\" : 885.0,\n                \"to\" : 1115.0,\n                \"doc_count\" : 10\n              },\n              {\n                \"key\" : \"1115.0-1335.0\",\n                \"from\" : 1115.0,\n                \"to\" : 1335.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"1335.0-1555.0\",\n                \"from\" : 1335.0,\n                \"to\" : 1555.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"1555.0-1775.0\",\n                \"from\" : 1555.0,\n                \"to\" : 1775.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"1775.0-*\",\n                \"from\" : 1775.0,\n                \"doc_count\" : 20\n              }\n            ]\n          },\n          \"bucket_correlation\" : {\n            \"value\" : 0.8402398981360937\n          }\n        },\n        {\n          \"key\" : \"2.0\",\n          \"doc_count\" : 100,\n          \"latency_ranges\" : {\n            \"buckets\" : [\n              {\n                \"key\" : \"*-0.0\",\n                \"to\" : 0.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"0.0-105.0\",\n                \"from\" : 0.0,\n                \"to\" : 105.0,\n                \"doc_count\" : 19\n              },\n              {\n                \"key\" : \"105.0-225.0\",\n                \"from\" : 105.0,\n                \"to\" : 225.0,\n                \"doc_count\" : 11\n              },\n              {\n                \"key\" : \"225.0-445.0\",\n                \"from\" : 225.0,\n                \"to\" : 445.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"445.0-665.0\",\n                \"from\" : 445.0,\n                \"to\" : 665.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"665.0-885.0\",\n                \"from\" : 665.0,\n                \"to\" : 885.0,\n                \"doc_count\" : 20\n              },\n              {\n                \"key\" : \"885.0-1115.0\",\n                \"from\" : 885.0,\n                \"to\" : 1115.0,\n                \"doc_count\" : 10\n              },\n              {\n                \"key\" : \"1115.0-1335.0\",\n                \"from\" : 1115.0,\n                \"to\" : 1335.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"1335.0-1555.0\",\n                \"from\" : 1335.0,\n                \"to\" : 1555.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"1555.0-1775.0\",\n                \"from\" : 1555.0,\n                \"to\" : 1775.0,\n                \"doc_count\" : 0\n              },\n              {\n                \"key\" : \"1775.0-*\",\n                \"from\" : 1775.0,\n                \"doc_count\" : 0\n              }\n            ]\n          },\n          \"bucket_correlation\" : {\n            \"value\" : -0.5759855613334943\n          }\n        }\n      ]\n    }\n  }\n}\n----\n"
}