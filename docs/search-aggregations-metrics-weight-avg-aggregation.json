{
    "meta": {
        "timestamp": "2024-11-01T03:02:53.893580",
        "size": 5964,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-weight-avg-aggregation.html",
        "type": "documentation",
        "role": [],
        "has_code": true,
        "title": "search-aggregations-metrics-weight-avg-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-metrics-weight-avg-aggregation]]\n=== Weighted avg aggregation\n++++\n<titleabbrev>Weighted avg</titleabbrev>\n++++\n\nA `single-value` metrics aggregation that computes the weighted average of numeric values that are extracted from the aggregated documents.\nThese values can be extracted either from specific numeric fields in the documents.\n\nWhen calculating a regular average, each datapoint has an equal \"weight\" ... it contributes equally to the final value. Weighted averages,\non the other hand, weight each datapoint differently. The amount that each datapoint contributes to the final value is extracted from the\ndocument.\n\nAs a formula, a weighted average is the `\u2211(value * weight) / \u2211(weight)`\n\nA regular average can be thought of as a weighted average where every value has an implicit weight of `1`.\n\n[[weighted-avg-params]]\n.`weighted_avg` Parameters\n[options=\"header\"]\n|===\n|Parameter Name |Description |Required |Default Value\n|`value` | The configuration for the field or script that provides the values |Required |\n|`weight` | The configuration for the field or script that provides the weights |Required |\n|`format` | The numeric response formatter |Optional |\n|===\n\nThe `value` and `weight` objects have per-field specific configuration:\n\n[[value-params]]\n.`value` Parameters\n[options=\"header\"]\n|===\n|Parameter Name |Description |Required |Default Value\n|`field` | The field that values should be extracted from |Required |\n|`missing` | A value to use if the field is missing entirely |Optional |\n|===\n\n[[weight-params]]\n.`weight` Parameters\n[options=\"header\"]\n|===\n|Parameter Name |Description |Required |Default Value\n|`field` | The field that weights should be extracted from |Required |\n|`missing` | A weight to use if the field is missing entirely |Optional |\n|===\n\n\n==== Examples\n\nIf our documents have a `\"grade\"` field that holds a 0-100 numeric score, and a `\"weight\"` field which holds an arbitrary numeric weight,\nwe can calculate the weighted average using:\n\n[source,console]\n--------------------------------------------------\nPOST /exams/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weighted_grade\": {\n      \"weighted_avg\": {\n        \"value\": {\n          \"field\": \"grade\"\n        },\n        \"weight\": {\n          \"field\": \"weight\"\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:exams]\n\nWhich yields a response like:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"weighted_grade\": {\n      \"value\": 70.0\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n\n\nWhile multiple values-per-field are allowed, only one weight is allowed. If the aggregation encounters\na document that has more than one weight (e.g. the weight field is a multi-valued field) it will abort the search.\nIf you have this situation, you should build a <<search-aggregations-metrics-weight-avg-aggregation-runtime-field>>\nto combine those values into a single weight.\n\nThis single weight will be applied independently to each value extracted from the `value` field.\n\nThis example show how a single document with multiple values will be averaged with a single weight:\n\n[source,console]\n--------------------------------------------------\nPOST /exams/_doc?refresh\n{\n  \"grade\": [1, 2, 3],\n  \"weight\": 2\n}\n\nPOST /exams/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weighted_grade\": {\n      \"weighted_avg\": {\n        \"value\": {\n          \"field\": \"grade\"\n        },\n        \"weight\": {\n          \"field\": \"weight\"\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST\n\nThe three values (`1`, `2`, and `3`) will be included as independent values, all with the weight of `2`:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"weighted_grade\": {\n      \"value\": 2.0\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n\nThe aggregation returns `2.0` as the result, which matches what we would expect when calculating by hand:\n`((1*2) + (2*2) + (3*2)) / (2+2+2) == 2`\n\n[[search-aggregations-metrics-weight-avg-aggregation-runtime-field]]\n==== Runtime field\n\nIf you have to sum or weigh values that don't quite line up with the indexed\nvalues, run the aggregation on a <<runtime,runtime field>>.\n\n[source,console]\n----\nPOST /exams/_doc?refresh\n{\n  \"grade\": 100,\n  \"weight\": [2, 3]\n}\nPOST /exams/_doc?refresh\n{\n  \"grade\": 80,\n  \"weight\": 3\n}\n\nPOST /exams/_search?filter_path=aggregations\n{\n  \"size\": 0,\n  \"runtime_mappings\": {\n    \"weight.combined\": {\n      \"type\": \"double\",\n      \"script\": \"\"\"\n        double s = 0;\n        for (double w : doc['weight']) {\n          s += w;\n        }\n        emit(s);\n      \"\"\"\n    }\n  },\n  \"aggs\": {\n    \"weighted_grade\": {\n      \"weighted_avg\": {\n        \"value\": {\n          \"script\": \"doc.grade.value + 1\"\n        },\n        \"weight\": {\n          \"field\": \"weight.combined\"\n        }\n      }\n    }\n  }\n}\n----\n\nWhich should look like:\n\n[source,console-result]\n----\n{\n  \"aggregations\": {\n    \"weighted_grade\": {\n      \"value\": 93.5\n    }\n  }\n}\n----\n\n\n==== Missing values\n\nBy default, the aggregation excludes documents with a missing or `null` value for the `value` or `weight` field. Use the\n `missing` parameter to specify a default value for these documents instead.\n\n[source,console]\n--------------------------------------------------\nPOST /exams/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weighted_grade\": {\n      \"weighted_avg\": {\n        \"value\": {\n          \"field\": \"grade\",\n          \"missing\": 2\n        },\n        \"weight\": {\n          \"field\": \"weight\",\n          \"missing\": 3\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:exams]\n"
}