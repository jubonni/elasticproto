{
    "meta": {
        "timestamp": "2024-11-01T02:49:26.748067",
        "size": 9387,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/tutorial-manage-data-stream-retention.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "tutorial-manage-data-stream-retention",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[tutorial-manage-data-stream-retention]]\n=== Tutorial: Data stream retention\n\nIn this tutorial, we are going to go over the data stream lifecycle retention; we will define it, go over how it can be configured\nand how it can gets applied. Keep in mind, the following options apply only to data streams that are managed by the data stream lifecycle.\n\n. <<what-is-retention>>\n. <<retention-configuration>>\n. <<effective-retention-calculation>>\n. <<effective-retention-application>>\n\nYou can verify if a data steam is managed by the data stream lifecycle via the <<data-streams-get-lifecycle,get data stream lifecycle API>>:\n\n////\n[source,console]\n----\nPUT /_index_template/template\n{\n  \"index_patterns\": [\"my-data-stream*\"],\n  \"template\": {\n    \"lifecycle\": {}\n  },\n  \"data_stream\": { }\n}\n\nPUT /_data_stream/my-data-stream\n----\n// TESTSETUP\n////\n\n////\n[source,console]\n----\nDELETE /_data_stream/my-data-stream*\nDELETE /_index_template/template\nPUT /_cluster/settings\n{\n  \"persistent\" : {\n    \"data_streams.lifecycle.retention.*\" : null\n  }\n}\n----\n// TEARDOWN\n////\n\n[source,console]\n--------------------------------------------------\nGET _data_stream/my-data-stream/_lifecycle\n--------------------------------------------------\n\nThe result should look like this:\n\n[source,console-result]\n--------------------------------------------------\n{\n  \"data_streams\": [\n    {\n      \"name\": \"my-data-stream\",                                   <1>\n      \"lifecycle\": {\n        \"enabled\": true                                           <2>\n      }\n    }\n  ]\n}\n--------------------------------------------------\n// TESTRESPONSE[skip:the result is for illustrating purposes only]\n<1> The name of your data stream.\n<2> Ensure that the lifecycle is enabled, meaning this should be `true`.\n\n[discrete]\n[[what-is-retention]]\n==== What is data stream retention?\n\nWe define retention as the least amount of time the data of a data stream are going to be kept in {es}. After this time period\nhas passed, {es} is allowed to remove these data to free up space and/or manage costs.\n\nNOTE: Retention does not define the period that the data will be removed, but the minimum time period they will be kept.\n\nWe define 4 different types of retention:\n\n* The data stream retention, or `data_retention`, which is the retention configured on the data stream level. It can be\nset via an <<index-templates,index template>> for future data streams or via the <<data-streams-put-lifecycle, PUT data\nstream lifecycle API>> for an existing data stream. When the data stream retention is not set, it implies that the data\nneed to be kept forever.\n* The global default retention, let's call it `default_retention`, which is a retention configured via the cluster setting\n<<data-streams-lifecycle-retention-default, `data_streams.lifecycle.retention.default`>> and will be\napplied to all data streams managed by data stream lifecycle that do not have `data_retention` configured. Effectively,\nit ensures that there will be no data streams keeping their data forever. This can be set via the\n<<cluster-update-settings, update cluster settings API>>.\n* The global max retention, let's call it `max_retention`, which is a retention configured via the cluster setting\n<<data-streams-lifecycle-retention-max, `data_streams.lifecycle.retention.max`>> and will be applied to\nall data streams managed by data stream lifecycle. Effectively, it ensures that there will be no data streams whose retention\nwill exceed this time period. This can be set via the <<cluster-update-settings, update cluster settings API>>.\n* The effective retention, or `effective_retention`, which is the retention applied at a data stream on a given moment.\nEffective retention cannot be set, it is derived by taking into account all the configured retention listed above and is\ncalculated as it is described <<effective-retention-calculation,here>>.\n\nNOTE: Global default and max retention do not apply to data streams internal to elastic. Internal data streams are recognised\n either by having the `system` flag set to `true` or if their name is prefixed with a dot (`.`).\n\n[discrete]\n[[retention-configuration]]\n==== How to configure retention?\n\n- By setting the `data_retention` on the data stream level. This retention can be configured in two ways:\n+\n-- For new data streams, it can be defined in the index template that would be applied during the data stream's creation.\nYou can use the <<indices-put-template,create index template API>>, for example:\n+\n[source,console]\n--------------------------------------------------\nPUT _index_template/template\n{\n  \"index_patterns\": [\"my-data-stream*\"],\n  \"data_stream\": { },\n  \"priority\": 500,\n  \"template\": {\n    \"lifecycle\": {\n      \"data_retention\": \"7d\"\n    }\n  },\n  \"_meta\": {\n    \"description\": \"Template with data stream lifecycle\"\n  }\n}\n--------------------------------------------------\n-- For an existing data stream, it can be set via the <<data-streams-put-lifecycle, PUT lifecycle API>>.\n+\n[source,console]\n----\nPUT _data_stream/my-data-stream/_lifecycle\n{\n  \"data_retention\": \"30d\" <1>\n}\n----\n// TEST[continued]\n<1> The retention period of this data stream is set to 30 days.\n\n- By setting the global retention via the `data_streams.lifecycle.retention.default` and/or `data_streams.lifecycle.retention.max`\nthat are set on a cluster level. You can be set via the <<cluster-update-settings, update cluster settings API>>. For example:\n+\n[source,console]\n--------------------------------------------------\nPUT /_cluster/settings\n{\n  \"persistent\" : {\n    \"data_streams.lifecycle.retention.default\" : \"7d\",\n    \"data_streams.lifecycle.retention.max\" : \"90d\"\n  }\n}\n--------------------------------------------------\n// TEST[continued]\n\n[discrete]\n[[effective-retention-calculation]]\n==== How is the effective retention calculated?\nThe effective is calculated in the following way:\n\n- The `effective_retention` is the `default_retention`, when `default_retention` is defined and the data stream does not\nhave `data_retention`.\n- The `effective_retention` is the `data_retention`, when `data_retention` is defined and if `max_retention` is defined,\nit is less than the `max_retention`.\n- The `effective_retention` is the `max_retention`, when `max_retention` is defined, and the data stream has either no\n`data_retention` or its `data_retention` is greater than the `max_retention`.\n\nThe above is demonstrated in the examples below:\n\n|===\n|`default_retention`    |`max_retention`    |`data_retention`   |`effective_retention`  |Retention determined by\n\n|Not set                |Not set            |Not set            |Infinite               |N/A\n|Not relevant           |12 months          |**30 days**        |30 days                |`data_retention`\n|Not relevant           |Not set            |**30 days**        |30 days                |`data_retention`\n|**30 days**            |12 months          |Not set            |30 days                |`default_retention`\n|**30 days**            |30 days            |Not set            |30 days                |`default_retention`\n|Not relevant           |**30 days**        |12 months          |30 days                |`max_retention`\n|Not set                |**30 days**        |Not set            |30 days                |`max_retention`\n|===\n\nConsidering our example, if we retrieve the lifecycle of `my-data-stream`:\n[source,console]\n----\nGET _data_stream/my-data-stream/_lifecycle\n----\n// TEST[continued]\n\nWe see that it will remain the same with what the user configured:\n[source,console-result]\n----\n{\n  \"global_retention\" : {\n    \"max_retention\" : \"90d\",                                   <1>\n    \"default_retention\" : \"7d\"                                 <2>\n  },\n  \"data_streams\": [\n    {\n      \"name\": \"my-data-stream\",\n      \"lifecycle\": {\n        \"enabled\": true,\n        \"data_retention\": \"30d\",                                <3>\n        \"effective_retention\": \"30d\",                           <4>\n        \"retention_determined_by\": \"data_stream_configuration\"  <5>\n      }\n    }\n  ]\n}\n----\n<1> The maximum retention configured in the cluster.\n<2> The default retention configured in the cluster.\n<3> The requested retention for this data stream.\n<4> The retention that is applied by the data stream lifecycle on this data stream.\n<5> The configuration that determined the effective retention. In this case it's the `data_configuration` because\nit is less than the `max_retention`.\n\n[discrete]\n[[effective-retention-application]]\n==== How is the effective retention applied?\n\nRetention is applied to the remaining backing indices of a data stream as the last step of\n<<data-streams-lifecycle-how-it-works, a data stream lifecycle run>>. Data stream lifecycle will retrieve the backing indices\nwhose `generation_time` is longer than the effective retention period and delete them. The `generation_time` is only\napplicable to rolled over backing indices and it is either the time since the backing index got rolled over, or the time\noptionally configured in the <<index-data-stream-lifecycle-origination-date,`index.lifecycle.origination_date`>> setting.\n\nIMPORTANT: We use the `generation_time` instead of the creation time because this ensures that all data in the backing\nindex have passed the retention period. As a result, the retention period is not the exact time data get deleted, but\nthe minimum time data will be stored.\n"
}