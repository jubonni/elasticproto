{
    "meta": {
        "timestamp": "2024-11-01T03:07:09.644274",
        "size": 5901,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/ilm-migrate-to-data-tiers.html",
        "type": "documentation",
        "role": [
            "xpack"
        ],
        "has_code": true,
        "title": "ilm-migrate-to-data-tiers",
        "version": "8.15"
    },
    "doc": "[role=\"xpack\"]\n[[ilm-migrate-to-data-tiers]]\n=== Migrate to data tiers routing API\n++++\n<titleabbrev>Migrate indices, ILM policies, and legacy, composable and component templates to data tiers routing</titleabbrev>\n++++\n\nSwitches the indices, ILM policies, and legacy, composable and component templates from using custom node attributes and\n<<shard-allocation-filtering, attribute-based allocation filters>> to using <<data-tiers, data tiers>>, and\noptionally deletes one legacy index template.\nUsing node roles enables {ilm-init} to <<data-tier-migration, automatically move the indices>> between\ndata tiers.\n\nMigrating away from custom node attributes routing can be manually performed\nas indicated in the <<migrate-index-allocation-filters, Migrate index allocation\nfilters to node roles>> page.\n\nThis API provides an automated way of executing three out of the four manual steps listed\nin the <<migrate-index-allocation-filters, migration guide>>:\n\n. <<stop-setting-custom-hot-attribute, Stop setting the custom hot attribute on new indices>>\n. <<remove-custom-allocation-settings, Remove custom allocation settings from existing {ilm-init} policies>>\n. <<set-tier-preference, Replace custom allocation settings from existing indices>> with the corresponding <<tier-preference-allocation-filter,tier preference>>\n\n[[ilm-migrate-to-data-tiers-request]]\n==== {api-request-title}\n\n`POST /_ilm/migrate_to_data_tiers`\n\nThe API accepts an optional body that allows you to specify:\n\n- The legacy index template name to delete. Defaults to none.\n- The name of the custom node attribute used for the indices and ILM policies allocation filtering.\nDefaults to `data`.\n\n[[ilm-migrate-to-data-tiers-prereqs]]\n==== {api-prereq-title}\n\n* {ilm-init} must be stopped before performing the migration. Use the <<ilm-stop-request, stop ILM API>>\nto stop {ilm-init} and <<ilm-get-status-request, get status API>> to wait until the\nreported operation mode is `STOPPED`.\n\n[[ilm-migrate-to-data-tiers-query-params]]\n==== {api-query-parms-title}\n\n`dry_run`::\n(Optional, Boolean)\nIf `true`, simulates the migration from node attributes based allocation filters to data tiers, but does\nnot perform the migration. This provides a way to retrieve the indices and ILM policies that need to be\nmigrated.\nDefaults to `false`.\n\nNOTE: When simulating a migration (ie. `dry_run` is `true`) {ilm-init} doesn't need to be stopped.\n\n[[ilm-migrate-to-data-tiers-example]]\n==== {api-examples-title}\n\nThe following example migrates the indices, ILM policies, legacy templates,\ncomposable, and component templates away from defining custom allocation filtering\nusing the `custom_attribute_name` node attribute, and deletes the legacy template\nwith name `global-template` if it exists in the system.\n\n////\n[source,console]\n----\nPOST _ilm/stop\n\nPUT _template/global-template\n{\n  \"index_patterns\": [\"migrate-to-tiers-*\"],\n  \"settings\": {\n     \"index.routing.allocation.require.custom_attribute_name\": \"hot\"\n  }\n}\n\nPUT _template/a-legacy-template\n{\n  \"index_patterns\": [\"legacy-template-migrate-to-tiers-*\"],\n  \"settings\": {\n     \"index.routing.allocation.require.custom_attribute_name\": \"hot\"\n  }\n}\n\nPUT _index_template/a-composable-template\n{\n\t\"index_patterns\": [ \"composable-template-migrate-to-tiers-*\" ],\n\t\"data_stream\": {},\n\t\"template\" : {\n\t\t\"settings\": {\n\t\t\t \"index.routing.allocation.require.custom_attribute_name\": \"hot\"\n\t\t}\n\t}\n}\n\nPUT _component_template/a-component-template\n{\n\t\"template\" : {\n\t\t\"settings\": {\n\t\t\t \"index.routing.allocation.require.custom_attribute_name\": \"hot\"\n\t\t}\n\t}\n}\n\nPUT warm-index-to-migrate-000001\n{\n  \"settings\": {\n    \"index.routing.allocation.require.custom_attribute_name\": \"warm\"\n  }\n}\n\nPUT _ilm/policy/policy_with_allocate_action\n{\n  \"policy\": {\n    \"phases\": {\n      \"warm\": {\n        \"actions\": {\n          \"allocate\": {\n            \"require\": {\n              \"custom_attribute_name\": \"warm\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"30d\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n----\n// TESTSETUP\n\n[source,console]\n----\nDELETE warm-index-to-migrate-000001\n\nDELETE _ilm/policy/policy_with_allocate_action\n\nDELETE _template/a-legacy-template\n\nDELETE _index_template/a-composable-template\n\nDELETE _component_template/a-component-template\n\nPOST _ilm/start\n----\n// TEARDOWN\n////\n\n[source,console]\n----------------------------------------------------------------\nPOST /_ilm/migrate_to_data_tiers\n{\n  \"legacy_template_to_delete\": \"global-template\",\n  \"node_attribute\": \"custom_attribute_name\"\n}\n----------------------------------------------------------------\n\nIf the request succeeds, a response like the following will be received:\n\n[source,console-result]\n------------------------------------------------------------------------------\n{\n  \"dry_run\": false,\n  \"removed_legacy_template\":\"global-template\", <1>\n  \"migrated_ilm_policies\":[\"policy_with_allocate_action\"], <2>\n  \"migrated_indices\":[\"warm-index-to-migrate-000001\"], <3>\n  \"migrated_legacy_templates\":[\"a-legacy-template\"], <4>\n  \"migrated_composable_templates\":[\"a-composable-template\"], <5>\n  \"migrated_component_templates\":[\"a-component-template\"] <6>\n}\n------------------------------------------------------------------------------\n\n<1> Shows the name of the legacy index template that was deleted. This will be missing\nif no legacy index template was deleted.\n<2> The ILM policies that were updated.\n<3> The indices that were migrated to <<tier-preference-allocation-filter,tier preference>> routing.\n<4> The legacy index templates that were updated to not contain custom routing settings for the\nprovided data attribute.\n<5> The composable index templates that were updated to not contain custom routing settings for the\nprovided data attribute.\n<6> The component templates that were updated to not contain custom routing settings for the\nprovided data attribute.\n"
}