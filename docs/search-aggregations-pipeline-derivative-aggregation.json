{
    "meta": {
        "timestamp": "2024-11-01T02:49:24.930067",
        "size": 9088,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline-derivative-aggregation.html",
        "type": "documentation",
        "role": [],
        "has_code": true,
        "title": "search-aggregations-pipeline-derivative-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-pipeline-derivative-aggregation]]\n=== Derivative aggregation\n++++\n<titleabbrev>Derivative</titleabbrev>\n++++\n\nA parent pipeline aggregation which calculates the derivative of a specified metric in a parent histogram (or date_histogram)\naggregation. The specified metric must be numeric and the enclosing histogram must have `min_doc_count` set to `0` (default\nfor `histogram` aggregations).\n\n==== Syntax\n\nA `derivative` aggregation looks like this in isolation:\n\n[source,js]\n--------------------------------------------------\n\"derivative\": {\n  \"buckets_path\": \"the_sum\"\n}\n--------------------------------------------------\n// NOTCONSOLE\n\n[[derivative-params]]\n.`derivative` Parameters\n[options=\"header\"]\n|===\n|Parameter Name |Description |Required |Default Value\n|`buckets_path` |The path to the buckets we wish to find the derivative for (see <<buckets-path-syntax>> for more\n details) |Required |\n |`gap_policy` |The policy to apply when gaps are found in the data (see <<gap-policy>> for more\n details)|Optional |`skip` \n |`format` |{javadoc}/java.base/java/text/DecimalFormat.html[DecimalFormat pattern] for the\noutput value. If specified, the formatted value is returned in the aggregation's\n`value_as_string` property |Optional | `null` \n|===\n\n\n==== First Order Derivative\n\nThe following snippet calculates the derivative of the total monthly `sales`:\n\n[source,console]\n--------------------------------------------------\nPOST /sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"sales_per_month\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"\n      },\n      \"aggs\": {\n        \"sales\": {\n          \"sum\": {\n            \"field\": \"price\"\n          }\n        },\n        \"sales_deriv\": {\n          \"derivative\": {\n            \"buckets_path\": \"sales\" <1>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n\n<1> `buckets_path` instructs this derivative aggregation to use the output of the `sales` aggregation for the derivative\n\nAnd the following may be the response:\n\n[source,console-result]\n--------------------------------------------------\n{\n   \"took\": 11,\n   \"timed_out\": false,\n   \"_shards\": ...,\n   \"hits\": ...,\n   \"aggregations\": {\n      \"sales_per_month\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"2015/01/01 00:00:00\",\n               \"key\": 1420070400000,\n               \"doc_count\": 3,\n               \"sales\": {\n                  \"value\": 550.0\n               } <1>\n            },\n            {\n               \"key_as_string\": \"2015/02/01 00:00:00\",\n               \"key\": 1422748800000,\n               \"doc_count\": 2,\n               \"sales\": {\n                  \"value\": 60.0\n               },\n               \"sales_deriv\": {\n                  \"value\": -490.0 <2>\n               }\n            },\n            {\n               \"key_as_string\": \"2015/03/01 00:00:00\",\n               \"key\": 1425168000000,\n               \"doc_count\": 2, <3>\n               \"sales\": {\n                  \"value\": 375.0\n               },\n               \"sales_deriv\": {\n                  \"value\": 315.0\n               }\n            }\n         ]\n      }\n   }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\"took\": 11/\"took\": $body.took/]\n// TESTRESPONSE[s/\"_shards\": \\.\\.\\./\"_shards\": $body._shards/]\n// TESTRESPONSE[s/\"hits\": \\.\\.\\./\"hits\": $body.hits/]\n\n<1> No derivative for the first bucket since we need at least 2 data points to calculate the derivative\n<2> Derivative value units are implicitly defined by the `sales` aggregation and the parent histogram so in this case the units\nwould be $/month assuming the `price` field has units of $.\n<3> The number of documents in the bucket are represented by the `doc_count`\n\n==== Second Order Derivative\n\nA second order derivative can be calculated by chaining the derivative pipeline aggregation onto the result of another derivative\npipeline aggregation as in the following example which will calculate both the first and the second order derivative of the total\nmonthly sales:\n\n[source,console]\n--------------------------------------------------\nPOST /sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"sales_per_month\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"\n      },\n      \"aggs\": {\n        \"sales\": {\n          \"sum\": {\n            \"field\": \"price\"\n          }\n        },\n        \"sales_deriv\": {\n          \"derivative\": {\n            \"buckets_path\": \"sales\"\n          }\n        },\n        \"sales_2nd_deriv\": {\n          \"derivative\": {\n            \"buckets_path\": \"sales_deriv\" <1>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n\n<1> `buckets_path` for the second derivative points to the name of the first derivative\n\nAnd the following may be the response:\n\n[source,console-result]\n--------------------------------------------------\n{\n   \"took\": 50,\n   \"timed_out\": false,\n   \"_shards\": ...,\n   \"hits\": ...,\n   \"aggregations\": {\n      \"sales_per_month\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"2015/01/01 00:00:00\",\n               \"key\": 1420070400000,\n               \"doc_count\": 3,\n               \"sales\": {\n                  \"value\": 550.0\n               } <1>\n            },\n            {\n               \"key_as_string\": \"2015/02/01 00:00:00\",\n               \"key\": 1422748800000,\n               \"doc_count\": 2,\n               \"sales\": {\n                  \"value\": 60.0\n               },\n               \"sales_deriv\": {\n                  \"value\": -490.0\n               } <1>\n            },\n            {\n               \"key_as_string\": \"2015/03/01 00:00:00\",\n               \"key\": 1425168000000,\n               \"doc_count\": 2,\n               \"sales\": {\n                  \"value\": 375.0\n               },\n               \"sales_deriv\": {\n                  \"value\": 315.0\n               },\n               \"sales_2nd_deriv\": {\n                  \"value\": 805.0\n               }\n            }\n         ]\n      }\n   }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\"took\": 50/\"took\": $body.took/]\n// TESTRESPONSE[s/\"_shards\": \\.\\.\\./\"_shards\": $body._shards/]\n// TESTRESPONSE[s/\"hits\": \\.\\.\\./\"hits\": $body.hits/]\n\n<1> No second derivative for the first two buckets since we need at least 2 data points from the first derivative to calculate the\nsecond derivative\n\n==== Units\n\nThe derivative aggregation allows the units of the derivative values to be specified. This returns an extra field in the response\n`normalized_value` which reports the derivative value in the desired x-axis units. In the below example we calculate the derivative\nof the total sales per month but ask for the derivative of the sales as in the units of sales per day:\n\n[source,console]\n--------------------------------------------------\nPOST /sales/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"sales_per_month\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"calendar_interval\": \"month\"\n      },\n      \"aggs\": {\n        \"sales\": {\n          \"sum\": {\n            \"field\": \"price\"\n          }\n        },\n        \"sales_deriv\": {\n          \"derivative\": {\n            \"buckets_path\": \"sales\",\n            \"unit\": \"day\" <1>\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:sales]\n<1> `unit` specifies what unit to use for the x-axis of the derivative calculation\n\nAnd the following may be the response:\n\n[source,console-result]\n--------------------------------------------------\n{\n   \"took\": 50,\n   \"timed_out\": false,\n   \"_shards\": ...,\n   \"hits\": ...,\n   \"aggregations\": {\n      \"sales_per_month\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"2015/01/01 00:00:00\",\n               \"key\": 1420070400000,\n               \"doc_count\": 3,\n               \"sales\": {\n                  \"value\": 550.0\n               } <1>\n            },\n            {\n               \"key_as_string\": \"2015/02/01 00:00:00\",\n               \"key\": 1422748800000,\n               \"doc_count\": 2,\n               \"sales\": {\n                  \"value\": 60.0\n               },\n               \"sales_deriv\": {\n                  \"value\": -490.0, <1>\n                  \"normalized_value\": -15.806451612903226 <2>\n               }\n            },\n            {\n               \"key_as_string\": \"2015/03/01 00:00:00\",\n               \"key\": 1425168000000,\n               \"doc_count\": 2,\n               \"sales\": {\n                  \"value\": 375.0\n               },\n               \"sales_deriv\": {\n                  \"value\": 315.0,\n                  \"normalized_value\": 11.25\n               }\n            }\n         ]\n      }\n   }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\"took\": 50/\"took\": $body.took/]\n// TESTRESPONSE[s/\"_shards\": \\.\\.\\./\"_shards\": $body._shards/]\n// TESTRESPONSE[s/\"hits\": \\.\\.\\./\"hits\": $body.hits/]\n\n<1> `value` is reported in the original units of 'per month'\n<2> `normalized_value` is reported in the desired units of 'per day'\n"
}