{
    "meta": {
        "timestamp": "2024-11-01T03:07:09.126271",
        "size": 7563,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-diversified-sampler-aggregation.html",
        "type": "documentation",
        "role": [],
        "has_code": true,
        "title": "search-aggregations-bucket-diversified-sampler-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-bucket-diversified-sampler-aggregation]]\n=== Diversified sampler aggregation\n++++\n<titleabbrev>Diversified sampler</titleabbrev>\n++++\n\nLike the `sampler` aggregation this is a filtering aggregation used to limit any sub aggregations' processing to a sample of the top-scoring documents.\nThe `diversified_sampler` aggregation adds the ability to limit the number of matches that share a common value such as an \"author\".\n\nNOTE: Any good market researcher will tell you that when working with samples of data it is important\nthat the sample represents a healthy variety of opinions rather than being skewed by any single voice.\nThe same is true with aggregations and sampling with these diversify settings can offer a way to remove the bias in your content (an over-populated geography,\na large spike in a timeline or an over-active forum spammer).\n\n\n.Example use cases:\n* Tightening the focus of analytics to high-relevance matches rather than the potentially very long tail of low-quality matches\n* Removing bias from analytics by ensuring fair representation of content from different sources\n* Reducing the running cost of aggregations that can produce useful results using only samples e.g. `significant_terms`\n\nThe `field` setting is used to provide values used for de-duplication and the `max_docs_per_value` setting controls the maximum\nnumber of documents collected on any one shard which share a common value. The default setting for `max_docs_per_value` is 1.\n\nThe aggregation will throw an error if the `field` produces multiple values for a single document (de-duplication using multi-valued fields is not supported due to efficiency concerns).\n\n\nExample:\n\nWe might want to see which tags are strongly associated with `#elasticsearch` on StackOverflow\nforum posts but ignoring the effects of some prolific users with a tendency to misspell #Kibana as #Cabana.\n\n[source,console,id=diversified-sampler-aggregation-example]\n--------------------------------------------------\nPOST /stackoverflow/_search?size=0\n{\n  \"query\": {\n    \"query_string\": {\n      \"query\": \"tags:elasticsearch\"\n    }\n  },\n  \"aggs\": {\n    \"my_unbiased_sample\": {\n      \"diversified_sampler\": {\n        \"shard_size\": 200,\n        \"field\": \"author\"\n      },\n      \"aggs\": {\n        \"keywords\": {\n          \"significant_terms\": {\n            \"field\": \"tags\",\n            \"exclude\": [ \"elasticsearch\" ]\n          }\n        }\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TEST[setup:stackoverflow]\n\nResponse:\n\n[source,console-result]\n--------------------------------------------------\n{\n  ...\n  \"aggregations\": {\n    \"my_unbiased_sample\": {\n      \"doc_count\": 151,           <1>\n      \"keywords\": {               <2>\n        \"doc_count\": 151,\n        \"bg_count\": 650,\n        \"buckets\": [\n          {\n            \"key\": \"kibana\",\n            \"doc_count\": 150,\n            \"score\": 2.213,\n            \"bg_count\": 200\n          }\n        ]\n      }\n    }\n  }\n}\n--------------------------------------------------\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n// TESTRESPONSE[s/2.213/$body.aggregations.my_unbiased_sample.keywords.buckets.0.score/]\n\n<1> 151 documents were sampled in total.\n<2> The results of the significant_terms aggregation are not skewed by any single author's quirks because we asked for a maximum of one post from any one author in our sample.\n\n==== Scripted example\n\nIn this scenario we might want to diversify on a combination of field values. We can use a <<runtime,runtime field>> to\nproduce a hash of the multiple values in a tags field to ensure we don't have a sample that consists of the same\nrepeated combinations of tags.\n\n[source,console,id=diversified-sampler-aggregation-runtime-field-example]\n----\nPOST /stackoverflow/_search?size=0\n{\n  \"query\": {\n    \"query_string\": {\n      \"query\": \"tags:kibana\"\n    }\n  },\n  \"runtime_mappings\": {\n    \"tags.hash\": {\n      \"type\": \"long\",\n      \"script\": \"emit(doc['tags'].hashCode())\"\n    }\n  },\n  \"aggs\": {\n    \"my_unbiased_sample\": {\n      \"diversified_sampler\": {\n        \"shard_size\": 200,\n        \"max_docs_per_value\": 3,\n        \"field\": \"tags.hash\"\n      },\n      \"aggs\": {\n        \"keywords\": {\n          \"significant_terms\": {\n            \"field\": \"tags\",\n            \"exclude\": [ \"kibana\" ]\n          }\n        }\n      }\n    }\n  }\n}\n----\n// TEST[setup:stackoverflow]\n\nResponse:\n\n[source,console-result]\n----\n{\n  ...\n  \"aggregations\": {\n    \"my_unbiased_sample\": {\n      \"doc_count\": 6,\n      \"keywords\": {\n        \"doc_count\": 6,\n        \"bg_count\": 650,\n        \"buckets\": [\n          {\n            \"key\": \"logstash\",\n            \"doc_count\": 3,\n            \"score\": 2.213,\n            \"bg_count\": 50\n          },\n          {\n            \"key\": \"elasticsearch\",\n            \"doc_count\": 3,\n            \"score\": 1.34,\n            \"bg_count\": 200\n          }\n        ]\n      }\n    }\n  }\n}\n----\n// TESTRESPONSE[s/\\.\\.\\./\"took\": $body.took,\"timed_out\": false,\"_shards\": $body._shards,\"hits\": $body.hits,/]\n// TESTRESPONSE[s/2.213/$body.aggregations.my_unbiased_sample.keywords.buckets.0.score/]\n// TESTRESPONSE[s/1.34/$body.aggregations.my_unbiased_sample.keywords.buckets.1.score/]\n\n==== shard_size\n\nThe `shard_size` parameter limits how many top-scoring documents are collected in the sample processed on each shard.\nThe default value is 100.\n\n==== max_docs_per_value\nThe `max_docs_per_value` is an optional parameter and limits how many documents are permitted per choice of de-duplicating value.\nThe default setting is \"1\".\n\n\n==== execution_hint\n\nThe optional `execution_hint` setting can influence the management of the values used for de-duplication.\nEach option will hold up to `shard_size` values in memory while performing de-duplication but the type of value held can be controlled as follows:\n\n - hold field values directly (`map`)\n - hold ordinals of the field as determined by the Lucene index (`global_ordinals`)\n - hold hashes of the field values - with potential for hash collisions (`bytes_hash`)\n\nThe default setting is to use <<eager-global-ordinals,`global_ordinals`>> if this information is available from the Lucene index and reverting to `map` if not.\nThe `bytes_hash` setting may prove faster in some cases but introduces the possibility of false positives in de-duplication logic due to the possibility of hash collisions.\nPlease note that Elasticsearch will ignore the choice of execution hint if it is not applicable and that there is no backward compatibility guarantee on these hints.\n\n==== Limitations\n\n[[div-sampler-breadth-first-nested-agg]]\n===== Cannot be nested under `breadth_first` aggregations\nBeing a quality-based filter the diversified_sampler aggregation needs access to the relevance score produced for each document.\nIt therefore cannot be nested under a `terms` aggregation which has the `collect_mode` switched from the default `depth_first` mode to `breadth_first` as this discards scores.\nIn this situation an error will be thrown.\n\n===== Limited de-dup logic.\nThe de-duplication logic applies only at a shard level so will not apply across shards.\n\n[[spec-syntax-geo-date-fields]]\n===== No specialized syntax for geo/date fields\nCurrently the syntax for defining the diversifying values is defined by a choice of `field` or\n`script` - there is no added syntactical sugar for expressing geo or date units such as \"7d\" (7\ndays). This support may be added in a later release and users will currently have to create these\nsorts of values using a script.\n"
}