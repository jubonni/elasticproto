{
    "meta": {
        "timestamp": "2024-11-01T03:07:08.933272",
        "size": 7858,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-stack-security.html",
        "type": "documentation",
        "role": [],
        "has_code": false,
        "title": "configuring-stack-security",
        "version": "8.15"
    },
    "doc": "[[configuring-stack-security]]\n== Start the {stack} with security enabled automatically\n\nWhen you start {es} for the first time, the following security configuration\noccurs automatically:\n\n* <<stack-security-certificates,Certificates and keys>> for TLS are\ngenerated for the transport and HTTP layers.\n* The TLS configuration settings are written to `elasticsearch.yml`.\n* A password is generated for the `elastic` user.\n* An enrollment token is generated for {kib}.\n\nYou can then start {kib} and enter the enrollment token, which is valid for 30\nminutes. This token automatically applies the security settings from your {es}\ncluster, authenticates to {es} with the built-in `kibana` service account, and\nwrites the security configuration to `kibana.yml`.\n\nNOTE: There are <<stack-skip-auto-configuration,some cases>> where security\ncan't be configured automatically because the node startup process detects that\nthe node is already part of a cluster, or that security is already configured or\nexplicitly disabled.\n\n[discrete]\n=== Prerequisites\n\n* https://www.elastic.co/downloads/elasticsearch[Download] and\nunpack the `elasticsearch` package distribution for your\nenvironment.\n* https://www.elastic.co/downloads/kibana[Download] and unpack\nthe `kibana` package distribution for your environment.\n\n[discrete]\n[[stack-start-with-security]]\n=== Start {es} and enroll {kib} with security enabled\n\n. From the installation directory, start {es}.\n+\n[source,shell]\n----\nbin/elasticsearch\n----\n+\nThe command prints the `elastic` user password and an enrollment token for {kib}.\n\n. Copy the generated `elastic` password and enrollment token. These credentials\nare only shown when you start {es} for the first time.\n+\n[NOTE]\n====\nIf you need to reset the password for the `elastic` user or other\nbuilt-in users, run the <<reset-password,`elasticsearch-reset-password`>> tool.\nTo generate new enrollment tokens for {kib} or {es} nodes, run the\n<<create-enrollment-token,`elasticsearch-create-enrollment-token`>> tool.\nThese tools are available in the {es} `bin` directory.\n====\n+\nWe recommend storing the `elastic` password as an environment variable in your shell. Example:\n+\n[source,sh]\n----\nexport ELASTIC_PASSWORD=\"your_password\"\n----\n\n. (Optional) Open a new terminal and verify that you can connect to your {es}\ncluster by making an authenticated call.\n+\n[source,shell]\n----\ncurl --cacert config/certs/http_ca.crt -u elastic:$ELASTIC_PASSWORD https://localhost:9200\n----\n// NOTCONSOLE\n\n. From the directory where you installed {kib}, start {kib}.\n+\n[source,shell]\n----\nbin/kibana\n----\n\n. Enroll {kib} using either interactive or detached mode.\n\n  * *Interactive mode* (browser)\n\n  .. In your terminal, click the generated link to open {kib} in your browser.\n  .. In your browser, paste the enrollment token that you copied and click the\n  button to connect your {kib} instance with {es}.\n+\n--\n[NOTE]\n====\n{kib} won't enter interactive mode if it detects existing credentials for {es}\n(`elasticsearch.username` and `elasticsearch.password`) or an existing URL for\n`elasticsearch.hosts`.\n====\n--\n\n  * *Detached mode* (non-browser)\n+\nRun the `kibana-setup` tool and pass the generated enrollment token with the\n`--enrollment-token` parameter.\n+\n[\"source\",\"sh\",subs=\"attributes\"]\n----\nbin/kibana-setup --enrollment-token <enrollment-token>\n----\n\n[discrete]\n[[stack-enroll-nodes]]\n=== Enroll additional nodes in your cluster\n\n:slash:     /\n\ninclude::enroll-nodes.asciidoc[]\n\n[discrete]\ninclude::{es-ref-dir}/setup/install/connect-clients.asciidoc[leveloffset=-1]\n\n[discrete]\n=== What's next?\nCongratulations! You've successfully started the {stack} with security enabled.\n{es} and {kib} are secured with TLS on the HTTP layer, and internode\ncommunication is encrypted. If you want to enable HTTPS for web traffic, you\ncan <<encrypt-kibana-browser,encrypt traffic between your browser and {kib}>>.\n\n[discrete]\n[[stack-security-certificates]]\ninclude::{es-ref-dir}/setup/install/security-files-reference.asciidoc[leveloffset=-2]\n\nAdditionally, when you use the enrollment token to connect {kib} to a secured {es} cluster, the HTTP layer CA certificate is retrieved from {es} and stored in the\n{kib} `/data` directory. This file establishes trust between {kib} and the {es}\nCertificate Authority (CA) for the HTTP layer.\n\n[discrete]\n[[stack-skip-auto-configuration]]\n=== Cases when security auto configuration is skipped\nWhen you start {es} for the first time, the node startup process tries to\nautomatically configure security for you. The process runs some checks to\ndetermine:\n\n* If this is the first time that the node is starting\n* Whether security is already configured\n* If the startup process can modify the node configuration\n\nIf any of those checks fail, there's a good indication that you\n<<manually-configure-security,manually configured security>>, or don't want\nsecurity to be configured automatically. In these cases, the node starts\nnormally using the existing configuration.\n\nIMPORTANT: If you redirect {es} output to a file, security autoconfiguration is skipped.\nAutoconfigured credentials can only be viewed on the terminal the first time you start {es}.\nIf you need to redirect output to a file, start {es} without redirection the first time\nand use redirection on all subsequent starts.\n\n[discrete]\n[[stack-existing-environment-detected]]\n==== Existing environment detected\nIf certain directories already exist, there's a strong indication that the node\nwas started previously. Similarly, if certain files _don't_ exist, or we can't\nread or write to specific files or directories, then we're likely not running as\nthe user who installed {es} or an administrator imposed restrictions. If any of\nthe following environment checks are true, security isn't configured\nautomatically.\n\nThe {es} `/data` directory exists and isn't empty::\nThe existence of this directory is a strong indicator that the node was started\npreviously, and might already be part of a cluster.\n\nThe `elasticsearch.yml` file doesn't exist (or isn't readable), or the `elasticsearch.keystore` isn't readable::\nIf either of these files aren't readable, we can't determine whether {es} security\nfeatures are already enabled. This state can also indicate that the node startup\nprocess isn't running as a user with sufficient privileges to modify the\nnode configuration.\n\nThe {es} configuration directory isn't writable::\nThis state likely indicates that an administrator made this directory read-only,\nor that the user who is starting {es} is not the user that installed {es}.\n\n[discrete]\n[[stack-existing-settings-detected]]\n==== Existing settings detected\nThe following settings are incompatible with security auto configuration. If any\nof these settings exist, the node startup process skips configuring security\nautomatically and the node starts normally.\n\n* {ref}/modules-node.html#node-roles[`node.roles`] is set to a value where the\nnode can't be elected as `master`, or if the node can't hold data\n* {ref}/security-settings.html#general-security-settings[`xpack.security.autoconfiguration.enabled`] is set to `false`\n* {ref}/security-settings.html#general-security-settings[`xpack.security.enabled`] has a value set\n* Any of the\n{ref}/security-settings.html#transport-tls-ssl-settings[`xpack.security.transport.ssl.*`] or\n{ref}/security-settings.html#http-tls-ssl-settings[`xpack.security.http.ssl.*`]\nsettings have a value set in the `elasticsearch.yml` configuration file or in\nthe `elasticsearch.keystore`\n* Any of the `discovery.type`, `discovery.seed_hosts`, or\n`cluster.initial_master_nodes`\n{ref}/modules-discovery-settings.html[discovery and cluster formation settings]\nhave a value set\n+\n--\n[NOTE]\n====\nExceptions are when `discovery.type` is set to `single-node`, or when\n`cluster.initial_master_nodes` exists but contains only the name of the current\nnode.\n====\n--\n"
}