{
    "meta": {
        "timestamp": "2024-11-01T03:02:52.535579",
        "size": 3827,
        "url": "https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-filter-aggregation.html",
        "type": "documentation",
        "role": [],
        "has_code": false,
        "title": "search-aggregations-bucket-filter-aggregation",
        "version": "8.15"
    },
    "doc": "[[search-aggregations-bucket-filter-aggregation]]\n=== Filter aggregation\n++++\n<titleabbrev>Filter</titleabbrev>\n++++\n\nA single bucket aggregation that narrows the set of documents\nto those that match a <<query-dsl,query>>.\n\nExample:\n\n[source,console,id=filter-aggregation-example]\n----\nPOST /sales/_search?size=0&filter_path=aggregations\n{\n  \"aggs\": {\n    \"avg_price\": { \"avg\": { \"field\": \"price\" } },\n    \"t_shirts\": {\n      \"filter\": { \"term\": { \"type\": \"t-shirt\" } },\n      \"aggs\": {\n        \"avg_price\": { \"avg\": { \"field\": \"price\" } }\n      }\n    }\n  }\n}\n----\n// TEST[setup:sales]\n\nThe previous example calculates the average price of all sales as well as\nthe average price of all T-shirt sales.\n\nResponse:\n\n[source,console-result]\n----\n{\n  \"aggregations\": {\n    \"avg_price\": { \"value\": 140.71428571428572 },\n    \"t_shirts\": {\n      \"doc_count\": 3,\n      \"avg_price\": { \"value\": 128.33333333333334 }\n    }\n  }\n}\n----\n\n[[use-top-level-query-to-limit-all-aggs]]\n==== Use a top-level `query` to limit all aggregations\n\nTo limit the documents on which all aggregations in a search run, use a\ntop-level `query`. This is faster than a single `filter` aggregation with\nsub-aggregations.\n\nFor example, use this:\n\n\n[source,console,id=filter-aggregation-top-good]\n----\nPOST /sales/_search?size=0&filter_path=aggregations\n{\n  \"query\": { \"term\": { \"type\": \"t-shirt\" } },\n  \"aggs\": {\n    \"avg_price\": { \"avg\": { \"field\": \"price\" } }\n  }\n}\n----\n// TEST[setup:sales]\n\n////\n[source,console-result]\n----\n{\n  \"aggregations\": {\n    \"avg_price\": { \"value\": 128.33333333333334 }\n  }\n}\n----\n////\n\nInstead of this:\n\n[source,console,id=filter-aggregation-top-bad]\n----\nPOST /sales/_search?size=0&filter_path=aggregations\n{\n  \"aggs\": {\n    \"t_shirts\": {\n      \"filter\": { \"term\": { \"type\": \"t-shirt\" } },\n      \"aggs\": {\n        \"avg_price\": { \"avg\": { \"field\": \"price\" } }\n      }\n    }\n  }\n}\n----\n// TEST[setup:sales]\n\n////\n[source,console-result]\n----\n{\n  \"aggregations\": {\n    \"t_shirts\": {\n      \"doc_count\": 3,\n      \"avg_price\": { \"value\": 128.33333333333334 }\n    }\n  }\n}\n----\n////\n\n[[use-filters-agg-for-multiple-filters]]\n==== Use the `filters` aggregation for multiple filters\n\nTo group documents using multiple filters, use the\n<<search-aggregations-bucket-filters-aggregation,`filters` aggregation>>. This\nis faster than multiple `filter` aggregations.\n\nFor example, use this:\n\n[source,console,id=filter-aggregation-many-good]\n----\nPOST /sales/_search?size=0&filter_path=aggregations\n{\n  \"aggs\": {\n    \"f\": {\n      \"filters\": { \n        \"filters\": {\n          \"hats\": { \"term\": { \"type\": \"hat\" } },\n          \"t_shirts\": { \"term\": { \"type\": \"t-shirt\" } }\n        }\n      },\n      \"aggs\": {\n        \"avg_price\": { \"avg\": { \"field\": \"price\" } }\n      }\n    }\n  }\n}\n----\n// TEST[setup:sales]\n\n////\n[source,console-result]\n----\n{\n  \"aggregations\": {\n    \"f\": {\n      \"buckets\": {\n        \"hats\": {\n          \"doc_count\": 3,\n          \"avg_price\": { \"value\": 150.0 }\n        },\n        \"t_shirts\": {\n          \"doc_count\": 3,\n          \"avg_price\": { \"value\": 128.33333333333334 }\n        }\n      }\n    }\n  }\n}\n----\n////\n\nInstead of this:\n\n[source,console,id=filter-aggregation-many-bad]\n----\nPOST /sales/_search?size=0&filter_path=aggregations\n{\n  \"aggs\": {\n    \"hats\": {\n      \"filter\": { \"term\": { \"type\": \"hat\" } },\n      \"aggs\": {\n        \"avg_price\": { \"avg\": { \"field\": \"price\" } }\n      }\n    },\n    \"t_shirts\": {\n      \"filter\": { \"term\": { \"type\": \"t-shirt\" } },\n      \"aggs\": {\n        \"avg_price\": { \"avg\": { \"field\": \"price\" } }\n      }\n    }\n  }\n}\n----\n// TEST[setup:sales]\n\n////\n[source,console-result]\n----\n{\n  \"aggregations\": {\n    \"hats\": {\n      \"doc_count\": 3,\n      \"avg_price\": { \"value\": 150.0 }\n    },\n    \"t_shirts\": {\n      \"doc_count\": 3,\n      \"avg_price\": { \"value\": 128.33333333333334 }\n    }\n  }\n}\n----\n////\n"
}